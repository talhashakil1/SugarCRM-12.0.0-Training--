(function(app){app.events.on('app:init',function(){app.plugins.register('PurchaseAndServiceChangeHandler',['view'],{bindDataChange:function(){this._super('bindDataChange');this.model.on('change:service',this.handleServiceChange,this);this.model.on('change:purchase_name',this.handlePurchaseChange,this);},handleServiceChange:function(){this._updateServiceDuration();this._updateStartEndDate();},_updateServiceDuration:function(){var service=this.model.get('service');if(service&&_.isEmpty(this.model.get('service_duration_unit'))){this.model.set('service_duration_unit','year');}else if(!service){this.model.set({'service_duration_unit':'day','service_duration_value':1});}},_updateStartEndDate:function(){if(this.model.get('service')){var endDate=this.getField('service_end_date');if(!_.isUndefined(endDate)){endDate.calculateEndDate();}}else{var closeDate=this.model.get('date_closed');this.model.set({'service_start_date':closeDate,'service_end_date':closeDate});}},handlePurchaseChange:function(){var purchase=!_.isUndefined(this.model.get('purchase'))?this.model.get('purchase'):{};var prodTemplateId=purchase.product_template_id||'';if(!_.isEmpty(prodTemplateId)){var modelFields=this.model.fields||{};var populateList={};if(!_.isUndefined(modelFields.product_template_name)&&!_.isUndefined(modelFields.product_template_name.populate_list)){populateList=modelFields.product_template_name.populate_list;}
this.setProductAutoPopulateFields(prodTemplateId,populateList);}},setProductAutoPopulateFields:function(prodTemplateId,populateList){if(!_.isEmpty(prodTemplateId)){app.api.call('read',app.api.buildURL('ProductTemplates/'+prodTemplateId),{},{success:_.bind(function(data){var productPopulateList=_.pick(data,_.keys(populateList));if(!_.isUndefined(productPopulateList.name)&&!_.isEmpty(this.model.get('name'))){delete productPopulateList.name;}
this.model.set(productPopulateList);if(this.model.get('service')!==true){this.model.set('service_duration_unit','day');this.model.set('service_duration_value','1');}
this.model.set('catalog_service_duration_value',data.service_duration_value);this.model.set('catalog_service_duration_unit',data.service_duration_unit);this.changed=true;},this)});}}});});})(SUGAR.App);