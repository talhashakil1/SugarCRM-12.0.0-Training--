(function(app){app.events.on('app:init',function(){app.plugins.register('KBContent',['view'],{events:{'click .mce-btnKBTemplate':'launchTemplateDrawer'},CONTENT_LOCALIZATION:1,CONTENT_REVISION:2,onAttach:function(component,plugin){this.on('init',function(){this._initKBListeners();if((this.tplName==='list'||(!_.isUndefined(this.context)&&this.context.get('isSubpanel')===true))&&this.tplName!=='panel-top'){this.context.on('list:editrow:fire',_.bind(function(model,view){this._initValidationHandler(model);},this));this.context.on('list:preview:fire',_.bind(function(model){this._initValidationHandler(model);},this));}else{this._initValidationHandler(this.model);}});},_initKBListeners:function(){if(_.isFunction(Object.getPrototypeOf(this)._initKBListeners)){Object.getPrototypeOf(this)._initKBListeners.call(this);return;}
this.context.on('button:create_localization_button:click',this.createLocalization,this);this.context.on('button:create_revision_button:click',this.createRevision,this);this.context.on('button:create_article_button:click',this.createArticle,this);},createLocalization:function(model){this.createRelatedContent(model,this.CONTENT_LOCALIZATION);},createRevision:function(model){this.createRelatedContent(model,this.CONTENT_REVISION);},createArticle:function(model){var module='KBContents',fields=app.metadata.getModule(model.module).fields,links=_.filter(fields,function(field){if(field.type!=='link'||!field.relationship){return false;}
return app.data.getRelatedModule(model.module,field.name)===module;}),bodyTmpl=app.template.getField('htmleditable_tinymce','create-article',module),attrs={name:model.get('name'),kbdocument_body:bodyTmpl({model:model})},link,prefill,relatedFields,self=this;if(links.length===0){prefill=app.data.createBean(module,attrs);}else{link=links.length===1?links[0].name:'kbcontents';prefill=app.data.createRelatedBean(model,null,link,attrs);relatedFields=app.data.getRelateFields(model.module,link);if(!_.isEmpty(relatedFields)){_.each(relatedFields,function(field){var parentValue=model.get(field.rname);prefill.set(field.name,parentValue);prefill.set(field.id_name,model.get('id'));},this);}}
app.drawer.open({layout:'create',context:{create:true,model:prefill,module:module}},function(context,newModel){if(newModel!==undefined&&links.length>0){var viewContext=context.parent.parent||context.parent;var subPanel=self._findSubpanel(viewContext,link);self._reloadSubpanel(subPanel,link);}});},createArticleSubpanel:function(){var model=this.context.parent.get('model');this.createArticle(model);},createRelatedContent:function(parentModel,type){var self=this,prefill=app.data.createBean('KBContents',{id:parentModel.get('id')});prefill.fetch({success:function(){var removeList=['id','is_external'];_.each(removeList,function(field){prefill.unset(field);});prefill.set('status','draft');prefill.set('assigned_user_id',app.user.get('id'));prefill.set('assigned_user_name',app.user.get('full_name'));if(type===self.CONTENT_LOCALIZATION){self._onCreateLocalization(prefill,parentModel);}else{self._onCreateRevision(prefill,parentModel);}},error:function(){app.alert.show('server-error',{level:'error',messages:'ERR_GENERIC_SERVER_ERROR'});}});},_onCreateLocalization:function(prefill,parentModel){if(!this.checkCreateLocalization(parentModel)){app.alert.show('localizations',{level:'warning',title:app.lang.get('LBL_CANNOT_CREATE_LOCALIZATION','KBContents'),autoClose:false});return;}
this.context.createAction=this.CONTENT_LOCALIZATION;prefill.set('related_languages',this.getAvailableLangsForLocalization(parentModel),{silent:true});var language=this._getNextAvailableLanguage(parentModel);prefill.set('language',language);prefill.unset('kbarticle_id',{silent:true});this._openCreateRelatedDrawer(prefill,parentModel);},_onCreateRevision:function(prefill,parentModel){this.context.createAction=this.CONTENT_REVISION;prefill.set('useful',parentModel.get('useful'));prefill.set('notuseful',parentModel.get('notuseful'));prefill.set('related_languages',[parentModel.get('language')],{silent:true});prefill.set('revision','');this.context.set('skipFetch',false);this._openCreateRelatedDrawer(prefill,parentModel);},_openCreateRelatedDrawer:function(prefill,parentModel){var layoutDef={layout:'create',context:{create:true,model:prefill,module:this.module,copiedFromModelId:parentModel.get('id'),parent:this.context,createAction:this.context.createAction}};if(this.context.loadDrawer==true){app.drawer.load(layoutDef);}else{var self=this;app.drawer.open(layoutDef,function(context,newModel){var link=self._getLinkNameByContextAction(context.get('createAction')),viewContext,subPanel;if(link){viewContext=context.parent.parent||context.parent;viewContext.resetLoadFlag();viewContext.loadData();subPanel=self._findSubpanel(viewContext,link);self._reloadSubpanel(subPanel,link);context.set('createAction',null);context.loadDrawer=null;}});}
prefill.trigger('duplicate:field',parentModel);},_reloadSubpanel:function(subPanel,link){if(!subPanel){return;}
subPanel.set('skipFetch',false);subPanel.set('collapsed',false);subPanel.parent.trigger('subpanel:reload',{links:[link]});},_findSubpanel:function(context,link){var child=context.getChildContext({link:link});return child.get('isSubpanel')===true?child:null;},_getLinkNameByContextAction:function(contextAction){switch(contextAction){case this.CONTENT_LOCALIZATION:return'localizations';case this.CONTENT_REVISION:return'revisions';}
return false;},checkCreateLocalization:function(model){var langs=this.getAvailableLangsForLocalization(model),config=app.metadata.getModule('KBContents','config');if(!langs||!config['languages']){return true;}
if(!config['languages']||config['languages'].length==langs.length){return false;}
return true;},_getNextAvailableLanguage:function(model){var usedLangs=this.getAvailableLangsForLocalization(model);var config=app.metadata.getModule('KBContents','config');var allLangs=_.map(config.languages,function(language){var langObject=_.omit(language,'primary');return _.first(_.keys(langObject));});var availableLangs=_.difference(allLangs,usedLangs);return _.first(availableLangs);},getAvailableLangsForLocalization:function(model){return model.get('related_languages')||[];},launchTemplateDrawer:function(){app.drawer.open({layout:'selection-list',context:{module:'KBContentTemplates'}},_.bind(function(model){if(!model){return;}
var self=this;var template=app.data.createBean('KBContentTemplates',{id:model.id});template.fetch({success:function(template){if(this.disposed===true){return;}
var replace=function(){self.model.set('kbdocument_body',template.get('body'));};if(!self.model.get('kbdocument_body')){replace();}else{app.alert.show('override_confirmation',{level:'confirmation',messages:app.lang.get('LBL_TEMPATE_LOAD_MESSAGE',self.module),onConfirm:replace});}},error:function(){app.alert.show('template-load-error',{level:'error',messages:app.lang.get('LBL_TEMPLATE_LOAD_ERROR','KBContentTemplates')});}});},this));},_initValidationHandler:function(model){if(model._initValidationHandler===true){return;}
model._initValidationHandler=true;var _doValidateExpDateFieldPartial=_.partial(this._doValidateExpDateField,model),_doValidateActiveDateFieldPartial=_.partial(this._doValidateActiveDateField,model),_validationCompletePartial=_.partial(this._validationComplete,model),_hideValidationAlert=_.partial(this._hideValidationAlert,model);app.error.errorName2Keys['expDateLow']='ERROR_EXP_DATE_LOW';app.error.errorName2Keys['activeDateApproveRequired']='ERROR_ACTIVE_DATE_APPROVE_REQUIRED';app.error.errorName2Keys['activeDateLow']='ERROR_ACTIVE_DATE_LOW';app.error.errorName2Keys['activeDateEmpty']='ERROR_ACTIVE_DATE_EMPTY';model.addValidationTask('exp_date_publish',_.bind(_doValidateExpDateFieldPartial,this));model.addValidationTask('active_date_approve',_.bind(_doValidateActiveDateFieldPartial,this));model.on('validation:complete',_validationCompletePartial,this);model.on('attributes:revert',_hideValidationAlert,this);},_doValidateExpDateField:function(model,fields,errors,callback){var expFName='exp_date',actFName='active_date',fieldName=expFName,expDate=model.get(fieldName),publishingDate=model.get(actFName),status=model.get('status'),changed=model.changedAttributes(model.getSynced())||{},errorKeys=[];if((this._isPublishingStatus(status)&&((!changed.status||!this._isPublishingStatus(changed.status))||(this._isMassUpdate()&&(!publishingDate||app.date(publishingDate).isBefore(Date.now())))))){publishingDate=app.date().formatServer(true);model.set(actFName,publishingDate);}
if(status!=='expired'&&expDate&&publishingDate&&app.date(expDate).isBefore(publishingDate)){if(!this.getField(fieldName)&&this.getField(actFName)){fieldName=actFName;}
errors[fieldName]=errors[fieldName]||{};errors[fieldName].expDateLow=true;errorKeys.push('expDateLow');}
if((this.context.get('layout')==='records'||this.context.get('isSubpanel')===true)&&!_.isUndefined(errors[fieldName])){this._alertError(errorKeys);}
callback(null,fields,errors);},_doValidateActiveDateField:function(model,fields,errors,callback){var fieldName='active_date',status=model.get('status'),publishingDate=model.get(fieldName),errorKeys=[];if(status=='approved'){if(publishingDate&&app.date(publishingDate).isBefore(Date.now())){errors[fieldName]=errors[fieldName]||{};errors[fieldName].activeDateLow=true;errorKeys.push('activeDateLow');if((this.context.get('layout')==='records'||this.context.get('isSubpanel')===true)&&!_.isEmpty(errors[fieldName])&&!this._isMassUpdate()){this._alertError(errorKeys);}
callback(null,fields,errors);}else if(!publishingDate&&!this._isMassUpdate()){app.alert.show('save_without_publish_date_confirmation',{level:'confirmation',messages:app.lang.get('LBL_SPECIFY_PUBLISH_DATE','KBContents'),confirm:{label:app.lang.get('LBL_YES')},cancel:{label:app.lang.get('LBL_NO')},onConfirm:function(){callback(null,fields,errors);},onCancel:_.bind(function(){var field=this.getField(fieldName,model);if(!_.isEmpty(field)){var fieldElement=field.getFieldElement();if(_.isFunction(this.handleFieldError)){this.handleFieldError(field,true);}
if(fieldElement.find(field.fieldTag).length===0){fieldElement.closest('[data-name='+fieldName+']').find('.record-edit-link-wrapper').click();}
_.defer(function(){field.$(field.fieldTag).focus();field.focus();});}
errors.kbcontentsValidationCancel={stub:true};callback(null,fields,errors);},this)});}else if(!publishingDate){errors[fieldName]=errors[fieldName]||{};errors[fieldName].activeDateEmpty=true;callback(null,fields,errors);}else{callback(null,fields,errors);}}else{callback(null,fields,errors);}},_isMassUpdate:function(){return this.action==='massupdate';},_validationComplete:function(model,isValid){if(isValid){this._hideValidationAlert();var changed=model.changedAttributes(model.getSynced());var current=model.get('status');if(current=='expired'){model.set('exp_date',app.date().formatServer(true));}else if(this._isPublishingStatus(current)&&!(changed.status&&this._isPublishingStatus(changed.status))){model.set('active_date',app.date().formatServer(true));}}},_hideValidationAlert:function(){app.alert.dismiss('kb-validation-error');},_alertError:function(keys){var messages=[];_.each(keys,function(key){messages.push(app.lang.get(app.error.errorName2Keys[key],'KBContents'));});if(messages.length>0){app.alert.show('kb-validation-error',{level:'error',messages:messages,autoClose:false});}},_isPublishingStatus:function(status){return['published'].indexOf(status)!==-1;},onDetach:function(){if(this.model){this.model.removeValidationTask('exp_date_publish');this.model.removeValidationTask('active_date_approve');}},saveAndCreate:function(){var createAction=this.context.parent.createAction,callback;if(!createAction){Object.getPrototypeOf(this).saveAndCreate.call(this);return;}
switch(createAction){case this.CONTENT_LOCALIZATION:callback=this.createLocalization;break;case this.CONTENT_REVISION:callback=this.createRevision;break;}
if(callback){this.initiateSave(_.bind(function(){this.context.loadDrawer=true;if(this.hasSubpanelModels){_.each(this.context.children,function(child){if(child.get('isCreateSubpanel')){this.context.trigger('subpanel:resetCollection:'+child.get('link'),true);}},this);this.hasSubpanelModels=false;}
callback.call(this,this.model);},this));}}});});})(SUGAR.App);