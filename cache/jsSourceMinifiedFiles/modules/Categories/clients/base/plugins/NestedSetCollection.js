(function(app){app.events.on('app:init',function(){app.augment('NestedSetBean',app.Bean.extend({children:null,initialize:function(attributes,options){app.Bean.prototype.initialize.call(this,attributes);this.on('sync',function(model,data,options,request){if(!_.isUndefined(model.children.rootCollection)){app.events.trigger('app:nestedset:sync:complete',model.children.rootCollection);}});},_initCallback:function(options){var callback={};callback.success=options.success||null;callback.complete=options.complete||null;callback.error=options.error||null;return callback;},set:function(data,options){if(_.isObject(data)&&!_.isEmpty(data.children)&&_.isNull(this.children)){this.children=this.collection.clone();this.children.module=this.collection.module;this.children.rootCollection=this.collection.rootCollection?this.collection.rootCollection:this.collection;this.children.reset(data.children.records);data=_.omit(data,'children');}
app.Bean.prototype.set.apply(this,arguments);this.module=data['_module']||this.collection.module;if(!_.isUndefined(app.metadata.getModule(this.module))){this.fields=app.metadata.getModule(this.module).fields;}
return this;},getChildren:function(options){options=options||{};options.callback=this._initCallback(options);var url=app.api.buildURL(this.module||this.collection.module,[this.get('id'),'children'].join('/'));app.api.call('read',url,{},options.callback);},getNext:function(options){options=options||{};options.callback=this._initCallback(options);var url=app.api.buildURL(this.module||this.collection.module,[this.get('id'),'next'].join('/'));app.api.call('read',url,{},options.callback);},getPrev:function(options){options=options||{};options.callback=this._initCallback(options);var url=app.api.buildURL(this.module||this.collection.module,[this.get('id'),'prev'].join('/'));app.api.call('read',url,{},options.callback);},getParent:function(options){options=options||{};options.callback=this._initCallback(options);var url=app.api.buildURL(this.module||this.collection.module,[this.get('id'),'parent'].join('/'));app.api.call('read',url,{},options.callback);},getPath:function(options){options=options||{};options.callback=this._initCallback(options);var url=app.api.buildURL(this.module||this.collection.module,[this.get('id'),'path'].join('/'));app.api.call('read',url,{},options.callback);},moveBefore:function(options){options=options||{};options.record=this.get('id');if(_.isUndefined(this.collection)){return;}
this.collection.moveBefore(options);},moveAfter:function(options){options=options||{};options.record=this.get('id');if(_.isUndefined(this.collection)){return;}
this.collection.moveAfter(options);},moveFirst:function(options){options=options||{};options.record=this.get('id');if(_.isUndefined(this.collection)){return;}
this.collection.moveFirst(options);},moveLast:function(options){options=options||{};options.record=this.get('id');if(_.isUndefined(this.collection)){return;}
this.collection.moveLast(options);}}),false);app.augment('NestedSetCollection',app.BeanCollection.extend({model:app.NestedSetBean,jsonTree:null,root:null,offset:-1,_initCallback:function(options){var self=this,callback={};callback.complete=options.complete||null;callback.error=options.error||null;callback.success=_.bind(function(data,response){this.tree({success:_.bind(function(){if(_.isFunction(options.success)){options.success(data,response);}
app.events.trigger('app:nestedset:sync:complete',self);},this),error:_.bind(function(collection,error){if(_.isFunction(options.error)){options.error(error);}},this)});},this);return callback;},parse:function(response,options){this.jsonTree=response;return app.BeanCollection.prototype.parse.apply(this,arguments);},sync:function(method,model,options){var callbacks=app.data.getSyncCallbacks(method,model,options);app.api.call(method,this.url,options,callbacks);},_reset:function(){if(this.length&&!_.isEmpty(this.rootCollection)){_.each(this.models,function(model){model=this.rootCollection.getChild(model);if(model){delete this.rootCollection._childsById[model.id];delete this.rootCollection._childsById[model.cid];}},this);}
this._childsById={};app.BeanCollection.prototype._reset.apply(this,arguments);return this;},add:function(models,options){app.BeanCollection.prototype.add.apply(this,arguments);if(this.length){var rootCollection=this.rootCollection||this;_.each(this.models,function(model){rootCollection._childsById[model.cid]=model;if(model.id!=null)rootCollection._childsById[model.id]=model;});}},remove:function(models,options){var rootCollection=this.rootCollection||this,i,l,model;for(i=0,l=models.length;i<l;i++){model=rootCollection.getChild(models[i]);if(!model)continue;delete rootCollection._childsById[model.id];delete rootCollection._childsById[model.cid];}
app.BeanCollection.prototype.remove.apply(this,arguments);return this;},getChild:function(obj){if(obj==null)return void 0;var rootCollection=this.rootCollection||this;rootCollection._idAttr||(rootCollection._idAttr=rootCollection.model.prototype.idAttribute);return rootCollection._childsById[obj.id||obj.cid||obj[rootCollection._idAttr]||obj];},tree:function(options){this.url=app.api.buildURL(this.module,[this.root,'tree'].join('/'));this.fetch(options);},_prepareInsertOptions:function(options){options=options||{};options.data=options.data||{name:'New node'};options.target=options.target||null;options.target=_.isObject(options.target)?options.target.get('id'):options.target;options.callback=this._initCallback(options);return options;},append:function(options){options=this._prepareInsertOptions(options);options.target=_.isEmpty(options.target)?this.root:options.target;var url=app.api.buildURL(this.module,['append',options.target].join('/'));app.api.call('create',url,options.data,options.callback);},prepend:function(options){options=this._prepareInsertOptions(options);options.target=_.isEmpty(options.target)?this.root:options.target;var url=app.api.buildURL(this.module,['prepend',options.target].join('/'));app.api.call('create',url,options.data,options.callback);},insertBefore:function(options){options=this._prepareInsertOptions(options);if(_.isEmpty(options.target)){return;}
var url=app.api.buildURL(this.module,['insertbefore',options.target].join('/'));app.api.call('create',url,options.data,options.callback);},insertAfter:function(options){options=this._prepareInsertOptions(options);if(_.isEmpty(options.target)){return;}
var url=app.api.buildURL(this.module,['insertafter',options.target].join('/'));app.api.call('create',url,options.data,options.callback);},_prepareMoveOptions:function(options){options=options||{};options.record=options.record||null;options.record=_.isObject(options.record)?options.record.get('id'):options.record;options.target=options.target||null;options.target=_.isObject(options.target)?options.target.get('id'):options.target;options.callback=this._initCallback(options);return options;},moveBefore:function(options){options=this._prepareMoveOptions(options);if(_.isEmpty(options.record)||_.isEmpty(options.target)){return;}
var url=app.api.buildURL(this.module,[options.record,'movebefore',options.target].join('/'));app.api.call('update',url,{},options.callback);},moveAfter:function(options){options=this._prepareMoveOptions(options);if(_.isEmpty(options.record)||_.isEmpty(options.target)){return;}
var url=app.api.buildURL(this.module,[options.record,'moveafter',options.target].join('/'));app.api.call('update',url,{},options.callback);},moveFirst:function(options){options=this._prepareMoveOptions(options);if(_.isEmpty(options.record)||_.isEmpty(options.target)){return;}
var url=app.api.buildURL(this.module,[options.record,'movefirst',options.target].join('/'));app.api.call('update',url,{},options.callback);},moveLast:function(options){options=this._prepareMoveOptions(options);if(_.isEmpty(options.record)||_.isEmpty(options.target)){return;}
var url=app.api.buildURL(this.module,[options.record,'movelast',options.target].join('/'));app.api.call('update',url,{},options.callback);}}),false);app.plugins.register('NestedSetCollection',['view','field'],{onAttach:function(component,plugin){this.on('init',function(){this.collection=new app.NestedSetCollection();this.collection.module=this.dataProvider||null;this.collection.root=this.root||null;},this);}});});})(SUGAR.App);