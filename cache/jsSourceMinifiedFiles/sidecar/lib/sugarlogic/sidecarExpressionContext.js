(function(){SUGAR.forms=SUGAR.forms||{};SUGAR.forms.animation=SUGAR.forms.animation||{};var SE=SUGAR.expressions;var App=SUGAR.App||App;var SEC=SE.SidecarExpressionContext=function(view,model,collection){this.view=view;if(collection instanceof App.data.beanCollection){this.collection=collection;}else{this.collection=view.collection||view.context.get('collection');}
this.model=model||view.model||view.context.get('model');};App.utils.extendFrom(SEC,SE.ExpressionContext,{dispose:function(){if(!this.view.disposed){var scContext=this.view.context;_.each(this.dependencies,function(dep){scContext.off('list:editrow:fire',null,dep);});}},initialize:function(depsMeta,isCreate){var relatedFields=[];var isCreate=isCreate||false;let scContext=this.view.context;let isCreateSubpanel=scContext.get('isCreateSubpanel');this.dependencies=[];var updateCollection=_.bind(function(models,trigger){_.each(models,function(model){if(trigger.dependency.testOnLoad||model.isNew()||isCreateSubpanel){trigger.context.isOnLoad=true;trigger.context.inCollection=true;SUGAR.forms.Trigger.fire.apply(trigger,[model]);trigger.context.isOnLoad=null;trigger.context.inCollection=null;}},this);},this);_.each(depsMeta,function(dep){var newDep=SUGAR.forms.Dependency.fromMeta(dep,this);if(newDep){relatedFields=_.union(relatedFields,newDep.getRelatedFields());this.dependencies.push(newDep);}},this);this._setupLinks(relatedFields);_.each(this.dependencies,function(newDep){if(scContext.isCreate()||newDep.fireLinkOnlyDependency()||isCreate){SUGAR.forms.Trigger.fire.apply(newDep.trigger);this.view.trigger('sugarlogic:initialize');}
if(newDep.testOnLoad){scContext.on('list:editrow:fire',function(){scContext.isOnLoad=true;SUGAR.forms.Trigger.fire.apply(this.trigger,arguments);scContext.isOnLoad=null;},newDep);}
if(this.collection instanceof SUGAR.App.data.beanCollection){this.collection.on('sync',function(synced,syncData){var models;var ids;if(synced instanceof SUGAR.App.data.beanCollection){ids=_.pluck(syncData,'id');models=synced.filter(function(model){return _.contains(ids,model.id);});_.defer(updateCollection,models,newDep.trigger);}else{updateCollection([synced],newDep.trigger);}},this);this.collection.on('add',function(model){updateCollection([model],newDep.trigger)},this);updateCollection(this.collection.models,newDep.trigger);}},this);this._requestRollups(relatedFields);this.view.on('render',function(){_.each(this.dependencies,function(dep){if(scContext.isCreate()||dep.fireLinkOnlyDependency()){SUGAR.forms.Trigger.fire.apply(dep.trigger);this.view.trigger('sugarlogic:initialize');}},this);},this);},getValue:function(varname){var value=this.model.get(varname),def=this.model.fields[varname],result;if(!def){SUGAR.App.logger.warn('Attempted to get a value for field '+varname
+' which is not a field in '+this.model.module);}
if(def&&def.type=='link'){value=varname;}
if(typeof(value)=="string"){value=value.replace(/\n/g,"");if((/^(\s*)$/).exec(value)!=null||value===""){result=SEC.parser.toConstant('""');}
else if((def.type!=='currency'&&def.type!=='enum')&&SE.isNumeric(value)){result=SEC.parser.toConstant(SE.unFormatNumber(value));}else if(def.type=="date"||def.type=="datetime"){value=App.date.stripIsoTimeDelimterAndTZ(value);value=App.date.parse(value);value.type=def.type;result=this.getDateExpression(value);}
else{result=SEC.parser.toConstant('"'+value+'"');}}else if(Array.isArray(value)){result=this.getEnumExpression(value);}else if(typeof(value)=="object"&&value!=null&&value.getTime){result=this.getDateExpression(value);}else if(typeof(value)=="number"){result=SEC.parser.toConstant(""+value);}else if(_.isBoolean(value)){result=value?new SUGAR.expressions.TrueExpression():new SUGAR.expressions.FalseExpression();}else{result=SEC.parser.toConstant('""');}
return result;},setValue:function(varname,value){if(typeof(this.model.fields[varname])!='object'){return;}
var targetDef=this.model.fields[varname];this.lockedFields=this.lockedFields||[];if(typeof(value)=='object'&&value.length>0&&targetDef.type!='multienum'){value=value.join(', ');}else if(value&&targetDef.type==='date'){value=App.date(value).formatServer(true);}else if(value&&targetDef.type==='datetimecombo'){value=App.date(value).format();}
if(targetDef.type=='bool'&&_.isString(value)){value=SUGAR.expressions.Expression.isTruthy(value);}
if(value&&(targetDef.type==='decimal'||targetDef.type==='float')){value=App.utils.formatNumber(value,targetDef.round||6,targetDef.precision||6,null,null);}
if(_.isString(value)&&targetDef.len&&value.length>targetDef.len){var self=this;value=value.substring(0,targetDef.len);this.model.once('change:'+varname,function(){var msg=SUGAR.App.lang.getAppString('LBL_FIELD_TRIMMED');SUGAR.forms.markField(varname,self.getElement(varname),msg);});}else if(SUGAR.forms.markedField[varname]){SUGAR.forms.unmarkField(varname,this.getElement(varname));}
if(!this.lockedFields[varname]){this.lockedFields[varname]=true;var el=this.getElement(varname);if(el){SUGAR.forms.FlashField($(el).parents('[data-fieldname="'+varname+'"]'),null,varname);}
var ret=this.model.set(varname,value);this.lockedFields=[];return ret;}},addListener:function(varname,callback,scope){if(this.collection){this.collection.off("change:"+varname,callback,scope);this.collection.on("change:"+varname,callback,scope);}
if(this.model){this.model.off("change:"+varname,callback,scope);this.model.on("change:"+varname,callback,scope);}},getElement:function(varname){var field=this.getField(varname);if(field&&field.el)
return field.el;},getField:function(varname){return this.view.getField(varname,this.model);},addClass:function(varname,css_class,includeLabel){var def=this.view.getFieldMeta(varname,true),props=includeLabel?["css_class","cell_css"]:["css_class"],el=this.getElement(varname),parent=$(el).closest('div.record-cell');_.each(props,function(prop){if(!def[prop]){def[prop]=css_class;}else if(def[prop].indexOf(css_class)==-1){def[prop]+=" "+css_class;}});this.view.setFieldMeta(varname,def);$(el).addClass(css_class);if(!def._isChild&&includeLabel&&parent){parent.addClass(css_class);}},removeClass:function(varname,css_class,includeLabel){var def=this.view.getFieldMeta(varname,true),field=this.view.getField(varname),props=includeLabel?["css_class","cell_css"]:["css_class"],el=this.getElement(varname),parent=$(el).closest('div.record-cell');_.each([field.def,def],function(d){_.each(props,function(prop){if(d[prop]&&d[prop].indexOf(css_class)!=-1){var defProp=(" "+d[prop]+" ").replace(new RegExp(' '+css_class+' '),"");d[prop]=defProp.trim();}});});this.view.setFieldMeta(varname,def);$(el).removeClass(css_class);if(!def._isChild&&includeLabel&&parent){parent.removeClass(css_class);parent.find("."+css_class).removeClass(css_class);}},getLink:function(variable){var model=this.model;if(model&&model.fields&&model.fields[variable])
return model.fields[variable];},showError:function(variable,error){},clearError:function(variable){},setStyle:function(variable,styles){},setRelatedFields:function(fields,silent,model){silent=!!silent;model=model||this.model;for(var link in fields){var linkVar=this._linkValueVarname(link),currValue=model.get(linkVar),forceChangeEvent=!!currValue,value=currValue||{};_.each(fields[link],function(values,type){if(_.isObject(values)){values=_.mapObject(values,function(val){return _.isArray(val)?_.object(val):val;});value[type]=_.extend(value[type]||{},values);}else{value[type]=values;}});var toSet={};toSet[linkVar]=value;model.set(toSet,{silent:silent});if(!silent&&forceChangeEvent){model.trigger("change:"+link,model);}}},getRelatedFieldValues:function(fields,module,record,silent){var self=this,api=App.api,model=record instanceof App.data.beanModel?record:this.model;if(fields.length>0){module=module||model.module||this.view.context.get('module');record=_.isString(record)?record:model.get("id");for(var i=0;i<fields.length;i++){var link=fields[i].link,toSet={};if(fields[i].type=="related"){var linkDef=model.fields[link];if(linkDef&&linkDef.id_name&&linkDef.module){var relId=model.get(linkDef.id_name);if(relId){fields[i].relId=relId
fields[i].relModule=linkDef.module;}}}
if(fields[i].relate){toSet[link]={};toSet[link][fields[i].type]={};toSet[link][fields[i].type][fields[i].relate]="";self.setRelatedFields(toSet,true,model);}}
var data={id:record,action:"related"};var params={module:module,fields:self._getUniqueFieldsList(fields)};api.call('create',api.buildURL('ExpressionEngine','related',data),_.extend(data,params),{success:function(resp){self.setRelatedFields(resp,silent,model);return resp;}});}
return null;},_getUniqueFieldsList:function(fieldsList){var newFieldsList=[];for(var i=0;i<fieldsList.length;i++){var fieldAlreadyExists=_.find(newFieldsList,function(field){return _.isEqual(field,fieldsList[i]);});if(!fieldAlreadyExists){newFieldsList.push(fieldsList[i]);}}
return newFieldsList;},updateRelatedFieldValue:function(link,ftype,field,value,isNew){var linkValues=this.model.get(this._linkValueVarname(link))||{},isNew=isNew||false,newValues={};if(!_.isUndefined(linkValues[ftype])||isNew){if(!field){linkValues[ftype]=value;}else if(!isNew&&!_.isUndefined(linkValues[ftype][field])){linkValues[ftype][field]=value;}else if(isNew){if(_.isUndefined(linkValues[ftype])){linkValues[ftype]={};}
linkValues[ftype][field]=value;}}
newValues[link]=linkValues;this.setRelatedFields(newValues,true);},_linkValueVarname:function(link){return'_'+link+'-rel_exp_values';},getRelatedCollectionValues:function(model,link,ftype,field){model=model||this.model;var linkValues=model.get(this._linkValueVarname(link))||{};var fieldVal=field+'_values';if(ftype){if(linkValues[ftype]&&linkValues[ftype][fieldVal]){return linkValues[ftype][fieldVal];}
return[];}
return linkValues;},updateRelatedCollectionValues:function(model,link,ftype,field,relModel,operation){model=model||this.model;var link=this._linkValueVarname(link);var linkValues=model.get(link)||{};var fTypes=[ftype];var fields=[field];if(!ftype){fTypes=_.keys(linkValues);}
_.each(fTypes,function(fType){if(fType=='related'){return;}
if(!field){fields=_.filter(_.keys(linkValues[fType]),function(field){return field.substr(-7)!='_values';});}
_.each(fields,function(field){var fieldVal=field+'_values';var isCurrency=relModel.fields[field]&&relModel.fields[field].type==='currency';var current=linkValues[fType]&&linkValues[fType][fieldVal]||{};if(!_.isEmpty(current)&&operation=='remove'){if(relModel.id in current){delete current[relModel.id];}
if(relModel.cid in current){delete current[relModel.cid];}}
if(!operation||operation=='add'){if(current[relModel.cid]&&relModel.id){delete current[relModel.cid];}
var id=relModel.id?relModel.id:relModel.cid;var value=relModel.get(field);if(isCurrency&&relModel.has(field)&&relModel.has('currency_id')&&!_.isUndefined(value)){value=App.currency.convertToBase(value,relModel.get('currency_id'));}
if(!_.isUndefined(value)){current[id]=value;}}
linkValues[fType]=linkValues[fType]||{};linkValues[fType][fieldVal]=current;},this);},this);model.set(link,linkValues);},getRelatedField:function(link,ftype,field){var linkVar=this._linkValueVarname(link);var linkValues=this.model.get(linkVar)||{};if(ftype=="related"&&!this.inCollection){return this._handleRelateExpression(link,field);}
if(typeof(linkValues[ftype])!="undefined"){if(!field){return linkValues[ftype];}else if(typeof(linkValues[ftype][field])!="undefined"){return linkValues[ftype][field];}}
if(this.inCollection){linkValues[ftype]=linkValues[ftype]||{};linkValues[ftype][field]=linkValues[ftype][field]||"";this.model.set(linkVar,linkValues,{silent:true});return"";}
if(this.model.isNew()){return"";}
var params={link:link,type:ftype};if(field){params.relate=field;}
this.getRelatedFieldValues([params]);linkValues=this.model.get(linkVar)||{};if(!_.isUndefined(linkValues[ftype])){if(!field){return linkValues[ftype];}else if(!_.isUndefined(linkValues[ftype][field])){return linkValues[ftype][field];}}
return'';},_handleRelateExpression:function(link,field){this.view.context.set("model",this.model);var isSubpanel=this.view.context.get('isSubpanel')===true;if(isSubpanel){var relContext=this.view.context.parent;}else{var relContext=this.view.context.getChildContext({link:link});}
relContext.prepare();var col=relContext.get("collection"),fields=relContext.get('fields')||[],self=this,rField=_.find(this.model.fields,function(def){return(def.type&&def.type=="relate"&&def.id_name&&def.link&&def.link==link)})||{},relModel=relContext.get("model");if(relContext.isDataFetched()&&!relContext.get("modelId")){relModel=col.length>0?col.models[0]:null;}
var idName=this.model.get(rField.id_name);var differentModel=relModel&&relModel.get('id')!==idName;var relationID;if(!_.isEmpty(rField)&&(!idName||differentModel)&&!isSubpanel){relContext.set({model:null});relContext.resetLoadFlag();if(!idName){return"";}}
if(_.isUndefined(this.view._loadedRelatedFields)){this.view._loadedRelatedFields={};}
if(idName){relationID=idName;}else{var relationship=this.model.fields[link].relationship;relationID=relationship?relationship:'';}
var cachedKey=link+'_'+field+'_'+relationID;if(field&&(!relContext.isDataFetched()||(relModel&&_.isUndefined(relModel.get(field))&&!relModel.getFetchRequest()))&&!this.view._loadedRelatedFields.hasOwnProperty(cachedKey)){_.each(fields,_.bind(function(iterField){var fieldCacheKey=link+'_'+iterField+'_'+relationID;this.view._loadedRelatedFields[fieldCacheKey]=fieldCacheKey;},this));if(!_.contains(fields,field)){fields.push(field);}
this._loadRelatedData(link,fields,relContext,rField);if(rField.id_name){this.addListener(rField.id_name,function(){this.view._loadedRelatedFields={};},this);}}
else if(relModel){var value=relModel.get(field);if(value){var def=relModel.fields[field];if(def.type=="date"||def.type=="datetime"){value=App.date.stripIsoTimeDelimterAndTZ(value);value=App.date.parse(value);value.type=def.type;}}
return value;}else if(!col.page){var model=this.model;SUGAR.App.utils.doWhen(function(){return col.page>0},function(){model.trigger("change:"+link,model);});}
return"";},getDateExpression:function(date){var d=new SE.DateExpression("");d.evaluate=function(){return this.value};d.value=date;return d;},getEnumExpression:function(array){var e=new SE.EnumExpression("");e.evaluate=function(){return this.value};e.value=array;return e;},_loadRelatedData:function(link,fields,relContext,rField){var self=this;if(!_.isEmpty(rField)&&this.model.get(rField.id_name)){var modelId=this.model.get(rField.id_name),model=relContext.get("model")||SUGAR.App.data.createRelatedBean(this.model,this.model.get(rField.id_name),link);relContext.set({modelId:modelId,model:model});}else{if(_.isEmpty(this.model.get("id")))
return"";}
relContext.prepare();relContext.set({'fields':_.union(relContext.get("fields")||[],fields),skipFetch:false});if(relContext.isDataFetched()){relContext.resetLoadFlag();}
var model=this.model;relContext.loadData({relate:_.isEmpty(rField),success:function(){model.trigger("change:"+link,model);}});},_setupLinks:function(relatedFields){_.each(relatedFields,function(field){if(field.link&&field.relate&&(field.type==="related"||field.type==="rollupSum")){var relContext=this.view.context.getChildContext({link:field.link});if(relContext){relContext.set("fields",_.union(relContext.get("fields")||[],[field.relate]));}}},this);},_requestRollups:function(relatedFields,model){model=model||this.model;if(!model.isNew()){this.getRelatedFieldValues(relatedFields,model.module,model,true);}},fireOnLoad:function(dep){},getAppListStrings:function(list){return SUGAR.App.lang.getAppListStrings(list);},parseDate:function(date,type){return SUGAR.App.date.parse(date);},setFieldDisabled:function(target,disabled){disabled=(_.isUndefined(disabled))?true:disabled;var field=this.getField(target);if(field){field.setDisabled(disabled,{trigger:true});if(_.isEqual(disabled,false)&&!_.isEqual(field.currentState,'edit')&&_.isEqual(this.view.currentState,'edit')&&!_.isEqual(this.view.inlineEditMode,true)){field.setMode('edit');this.view.editableFields.push(field);}
if(_.isFunction(this.view.setEditableFields)){this.view.setEditableFields();}}},setFieldRequired:function(target,required){required=SUGAR.expressions.Expression.isTruthy(required);var field=this.view.getField(target,this.model);if(field){field.def.required=required;field.render();}},setAssignedUserName:function(target,username){if(this.model.has('assigned_user_name')&&this.model.has('assigned_user_id')){var self=this,options={},usersCollection=SUGAR.App.data.createBeanCollection('Users');options.filter={filter:[{user_name:username}]}
options.success=function(collection){var userModel=collection.first();if(userModel){self.model.set({'assigned_user_name':userModel.get('full_name'),'assigned_user_id':userModel.get('id')});var field=self.view.getField(target,self.model);if(field&&field.el){SUGAR.forms.FlashField(field.el,null,target);}}}
options.error=function(){SUGAR.App.alert.show('server-error',{level:'error',title:SUGAR.App.lang.get('ERR_GENERIC_TITLE'),messages:SUGAR.App.lang.get('ERR_ASSIGNTO_ACTION')});}
usersCollection.fetch({fields:['full_name'],limit:1,params:options.filter,success:options.success,error:options.error});}},setModel:function(model){this.model=model;},setRelatedModel:function(model){this.relatedModel=model;},add:function(start,add){return SUGAR.App.math.add(start,add,6,true);},subtract:function(start,subtract){return SUGAR.App.math.sub(start,subtract,6,true);},multiply:function(start,multiply){return SUGAR.App.math.mul(start,multiply,6,true);},divide:function(start,divide){return SUGAR.App.math.div(start,divide,6,true);},round:function(start,precision){return SUGAR.App.math.round(start,precision,true);},getNestedCollectionFromModel:function(linkName,model){var nestedCollection;model=model||this.model;var collectionFields=_.pluck(model.fieldsOfType('collection'),'name');if(!_.isEmpty(collectionFields)){var collectionField=_.chain(collectionFields).filter(function(f){return _.contains(model.fields[f].links,linkName);},this).value();if(_.size(collectionField)===1){var cf=_.first(collectionField);if(model.has(cf)){nestedCollection=model.get(cf);if(!(nestedCollection instanceof SUGAR.App.data.beanCollection)){nestedCollection=undefined;}}else{nestedCollection=cf;}}}
return nestedCollection;},getLinkContext:function(view,linkName){var LinkContext=view.context.getChildContext({link:linkName});LinkContext.prepare();return LinkContext;}});SEC.parser=new SUGAR.expressions.ExpressionParser();SEC.evalVariableExpression=function(expression,view){return SEC.parser.evaluate(expression,new SEC(view));}
SUGAR.forms.Dependency=function(trigger,actions,falseActions,testOnLoad,context){this.actions=actions;this.falseActions=falseActions;this.context=context;this.testOnLoad=testOnLoad;this.trigger=trigger;trigger.setContext(this.context);trigger.setDependency(this);if(testOnLoad){context.fireOnLoad(this);}}
SUGAR.forms.Dependency.fromMeta=function(meta,context){var condition=meta.trigger||'true',triggerFields=meta.triggerFields||SE.ExpressionParser.prototype.getFieldsFromExpression(condition),relatedFields=meta.relatedFields||[],actions=meta.actions||[],falseActions=meta.notActions||[],onLoad=meta.onload||false,isNew=context.model&&_.isEmpty(context.model.get('id')),actionObjects=[],falseActionObjects=[];if(_.isEmpty(triggerFields)&&!onLoad&&!isNew)
return null;if(_.isEmpty(actions)&&_.isEmpty(falseActions))
return null;_.each(actions,function(actionDef){if(!actionDef.action||!SUGAR.forms[actionDef.action+'Action'])
return;var addAction=true;if(actionDef.action==='SetValue'&&actionDef.params.target){addAction=SUGAR.App.acl.hasAccess('edit',this.model.module,undefined,actionDef.params.target);}
if(addAction){actionObjects.push(new SUGAR.forms[actionDef.action+'Action'](actionDef.params));}},context);_.each(falseActions,function(actionDef){if(!actionDef.action||!SUGAR.forms[actionDef.action+'Action'])
return;var addAction=true;if(actionDef.action==='SetValue'&&actionDef.params.target){addAction=SUGAR.App.acl.hasAccess('edit',this.model.module,undefined,actionDef.params.target);}
if(addAction){falseActionObjects.push(new SUGAR.forms[actionDef.action+'Action'](actionDef.params));}},context);return new SUGAR.forms.Dependency(new SUGAR.forms.Trigger(triggerFields,condition,context,relatedFields),actionObjects,falseActionObjects,onLoad,context);};SUGAR.forms.Dependency.prototype.fireLinkOnlyDependency=function(){if(!this.testOnLoad){return false;}
var fire=true;if(this.context.model.fields){_.each(this.trigger.variables,function(field){fire=(fire&&this.context.model.fields[field]&&this.context.model.fields[field].type=="link");},this);}
return fire;}
SUGAR.forms.Dependency.prototype.fire=function(undo){if(this.context.view.disposed||!this.context.view.context){return;}
try{var model=this.context.model;this.lastTriggeredActions=this.lastTriggeredActions||[];if(model.inSync&&!this.testOnLoad){return;}
var actions=this.actions;if(undo&&this.falseActions!=null)
actions=this.falseActions;_.each(this.lastTriggeredActions,function(action){this.context.view.off(null,null,action);},this);if(actions instanceof SUGAR.forms.AbstractAction)
actions=[actions];for(var i in actions){var action=actions[i];if(typeof action.exec=="function"){action.setContext(this.context);action.exec();if(this.testOnLoad&&action.afterRender){if(this.context.view.action==='list'){this.context.view.on('render',function(){var prevModel=action.context.model;action.context.setModel(model);action.exec();action.context.setModel(prevModel);},this);}}}}
this.lastTriggeredActions=actions;}catch(e){if(!SUGAR.isIE&&console&&console.log){console.log('ERROR: '+e);}
return;}};SUGAR.forms.Dependency.prototype.getRelatedFields=function(){var parser=SEC.parser,fields=parser.getRelatedFieldsFromFormula(this.trigger.condition);var parse=function(actions){if(actions instanceof SUGAR.forms.AbstractAction){actions=[actions];}
for(var i in actions){var action=actions[i],actionTarget=action.target||undefined;if(typeof action.exec=="function"){for(var p in action){if(typeof action[p]=="string"&&action[p].indexOf('$')>-1){fields=$.merge(fields,parser.getRelatedFieldsFromFormula(action[p],actionTarget));}}}}}
parse(this.actions);parse(this.falseActions);return fields;}
SUGAR.forms.AbstractAction=function(target){this.target=target;};SUGAR.forms.AbstractAction.prototype.exec=function(){}
SUGAR.forms.AbstractAction.prototype.setContext=function(context){this.context=context;}
SUGAR.forms.AbstractAction.prototype.evalExpression=function(exp,context){context=context||this.context;return SEC.parser.evaluate(exp,context).evaluate();}
SUGAR.forms.AbstractAction.prototype.canSetValue=function(context){if(context.options&&context.options.revert){return false;}
let isCreateSubpanel=context.view&&context.view.context&&context.view.context.get('isCreateSubpanel');if(context.isOnLoad&&!context.model.isNew()&&!isCreateSubpanel){return false;}
return true;};SUGAR.forms.Trigger=function(variables,condition,context,relatedFields){this.variables=variables;this.condition=condition;this.context=context;this.relatedFields=relatedFields||[];this.dependency={};};SUGAR.forms.Trigger.prototype._findRelatedCollection=function(link_name,model){model=model||this.context.model;var varContextCollection=this.context.getNestedCollectionFromModel(link_name,model);if(_.isUndefined(varContextCollection)){var varContext=this.context.getLinkContext(this.context.view,link_name);if(varContext&&varContext.has('collection')){varContextCollection=varContext.get('collection');}}
return varContextCollection;};SUGAR.forms.Trigger.prototype._attachListeners=function(){if(!(this.variables instanceof Array)){this.variables=[this.variables];}
for(var i=0;i<this.variables.length;i++){this.context.addListener(this.variables[i],SUGAR.forms.Trigger.fire,this,true);}
var models=[this.context.model];if(this.context.useCollection){models=this.context.collection.models;this.context.collection.off('add',null,this);this.context.collection.off('remove',null,this);this.context.collection.on('add',function(model,collection,options){this._attachCollectionListeners(model);},this);this.context.collection.on('remove',function(model,collection,options){_.each(model._relatedCollections,function(collection){collection.off(null,null,this);})
model.off(null,null,this);},this);}
_.each(models,function(model){this._attachCollectionListeners(model);},this);};SUGAR.forms.Trigger.prototype._attachCollectionListeners=function(model,triggerLink,relModel){var relFields=this.relatedFields,linkFields=[],changingField,isRemoveEvent=false;triggerLink=triggerLink||false;_.each(this.dependency.getRelatedFields(),function(field){linkFields[field.link]=_.union(linkFields[field.link]||[],[field.relate]);});var colChangeCallback=_.bind(function(relModel,value,event){if(value!==null&&!_.isUndefined(value)){_.find(relModel.changed,function(v,k){if(_.contains(relFields,k)&&v===value){changingField=k;return true;}});}else if(event&&event.type=='remove'){this.context.isRemoveEvent=true;}
if(event&&event.link){this.context.updateRelatedCollectionValues(model,event.link,null,null,relModel,event.type);}
var prevModel=this.context.model;this.context.model=model;this.context.changingField=changingField;SUGAR.forms.Trigger.fire.call(this,relModel,null,{fromRelated:true,changingField:changingField,isRemoveEvent:isRemoveEvent});this.context.model=prevModel;delete this.context.isRemoveEvent
delete this.context.changingField;},this);for(var i=0;i<this.variables.length;i++){var link=this.variables[i];var linkRelatedFields=linkFields[link]||[];var varContextCollection=this._findRelatedCollection(link,model);if(varContextCollection instanceof Backbone.Collection){varContextCollection.off('add',null,this);varContextCollection.on('add',function(relModel){colChangeCallback(relModel,null,{type:'add',link:link});},this);varContextCollection.off('remove',null,this);varContextCollection.on('remove',function(relModel){colChangeCallback(relModel,null,{type:'remove',link:link});},this);if(!_.isEmpty(linkRelatedFields)){var events='change:'+_.unique(linkRelatedFields).join(' change:');varContextCollection.off(events,null,this);varContextCollection.on(events,colChangeCallback,this);}}else if(_.isString(varContextCollection)){model.once('change:'+varContextCollection,function(parentModel,changedRelatedModel){this._attachListeners();if(_.isObject(changedRelatedModel)&&_.intersection(_.keys(changedRelatedModel.changed),relFields).length>0){SUGAR.forms.Trigger.fire.call(this,model);}},this);return varContextCollection;}}
if(triggerLink&&_.contains(this.variables,triggerLink)){colChangeCallback(relModel,null,'add');}};SUGAR.forms.Trigger.prototype.setDependency=function(dep){this.dependency=dep;this._attachListeners();}
SUGAR.forms.Trigger.prototype.setContext=function(context){this.context=context;}
SUGAR.forms.Trigger.fire=function(model,value,options){options=options||{};var evaluation,val,prevModel,prevRelatedModel;if(model){var fromRelated=options.fromRelated||false;if(!fromRelated&&model){prevModel=this.context.model;this.context.setModel(model);}else if(fromRelated){prevRelatedModel=this.context.relatedModel;this.context.setRelatedModel(model);}}
this.context.options=options;try{evaluation=SEC.parser.evaluate(this.condition,this.context);}catch(e){if(!SUGAR.isIE&&console&&console.log){console.log('ERROR:'+e+'; in Condition: '+this.condition);}}
if(!_.isUndefined(evaluation)){val=evaluation.evaluate();}
if(val==SUGAR.expressions.Expression.TRUE){if(this.dependency instanceof SUGAR.forms.Dependency){this.dependency.fire(false);}}else if(val==SUGAR.expressions.Expression.FALSE){if(this.dependency instanceof SUGAR.forms.Dependency){this.dependency.fire(true);}}
if(!fromRelated&&model){this.context.setModel(prevModel);}
if(fromRelated){this.context.setRelatedModel(prevModel);}};SUGAR.forms.flashInProgress={};SUGAR.forms.markedField={};SUGAR.forms.exclamationMarkTemplate=Handlebars.compile('<span class="warning-tooltip add-on" data-container="body" rel="tooltip" title="{{this}}"><i class="fa fa-warning"></i></span>');SUGAR.forms.FlashField=function(field,to_color,key){if(typeof(field)=='undefined'||(!key&&!field.id))
return;key=key||field.id;if(SUGAR.forms.flashInProgress[key])
return;SUGAR.forms.flashInProgress[key]=true;let $field=$(field);if(!$field.length){return;}
to_color=to_color||'#FF8F8F';let original=window.getComputedStyle($field[0],null).getPropertyValue('background-color');$field.css('backgroundColor',original);$field.animate({backgroundColor:to_color},200,function(){$field.animate({backgroundColor:original},200,function(){delete SUGAR.forms.flashInProgress[key];});});};SUGAR.forms.markField=function(key,el,text){if(SUGAR.forms.markedField[key])
return;if(!el)
return;var field=$(el).parents('[data-fieldname="'+key+'"]');var $ftag=$(el).children();field.addClass('warning');var $tooltip=$(SUGAR.forms.exclamationMarkTemplate(text));var isWrapped=$ftag.parent().hasClass('input-append');if(!isWrapped){$ftag.wrap('<div class="input-append warning">');}
$ftag.parent().addClass('warning');$ftag.after($tooltip);SUGAR.forms.markedField[key]=$tooltip;};SUGAR.forms.unmarkField=function(key,el){if(!SUGAR.forms.markedField[key])
return;if(!el)
return;var field=$(el).parents('[data-fieldname="'+key+'"]');field.removeClass('warning');SUGAR.forms.markedField[key].remove();SUGAR.forms.markedField[key]=null;};SE.plugin={onAttach:function(){this.on('init',function(){this.startSugarLogic();},this);},startSugarLogic:function(){this._slCtx=this.initSugarLogic();Object.defineProperty(this,'slContext',{get:function(){SUGAR.App.logger.warn('`View.slContext` has been deprecated since 7.9.');return this._slCtx;},configurable:true,enumerable:true,});this.context.addFields(this._getDepFields());},initSugarLogic:function(model,dependencies,isCreate){model=model||this.model;this._dependencies=dependencies||this.getApplicableDeps();isCreate=isCreate||false;var slContext=new SUGAR.expressions.SidecarExpressionContext(this,model,this.collection);if(_.isEmpty(this._dependencies)){return slContext;}
slContext.initialize(this._dependencies,isCreate);return slContext;},_getDepFields:function(){var fields;var getFields=SE.ExpressionParser.prototype.getFieldsFromExpression;var deps=this.getApplicableDeps();_.each(deps,function(dep){if(dep.trigger){fields=_.union(fields,getFields(dep.trigger));}
_.each(dep.actions,function(action){_.each(action.params,function(param){if(_.isString(param)){fields=_.union(fields,getFields(param));}});});});if(this.model){fields=_.filter(fields,function(field){return this.model.fields&&this.model.fields[field]&&this.model.fields[field].type!=='link';},this);}
return fields;},getApplicableDeps:function(){var meta=_.extend({},this.meta,this.options.meta),modDeps=SUGAR.App.metadata.getModule(this.context.get("module"),"dependencies"),action=(_.contains(this.plugins,'Editable')||this.name=='edit'||this.name=='create')?"edit":"view",deps=meta.dependencies;if(!_.isEmpty(modDeps)){var filteredModDeps=_.filter(modDeps,function(dep){if(_.contains(dep.hooks,"all")||_.contains(dep.hooks,action)){return true;}
return false;});deps=(!_.isEmpty(deps))?_.union(deps,filteredModDeps):filteredModDeps;}
return deps;},stopSugarLogic:function(){this.off(null,null,this._slCtx);this.model&&this.model.off(null,null,this._slCtx);this.collection&&this.collection.off(null,null,this._slCtx);_.each(this._slCtx.dependencies,function(dep){this.context.off('list:editrow:fire',null,dep);_.each(dep.actions,function(action){this.off(null,null,action);},this);},this);},onDetach:function(){this.stopSugarLogic();},};if(SUGAR.App&&SUGAR.App.plugins){SUGAR.App.plugins.register('SugarLogic','view',SE.plugin);}else if(console.error){console.error("unable to find the plugin manager");}})();