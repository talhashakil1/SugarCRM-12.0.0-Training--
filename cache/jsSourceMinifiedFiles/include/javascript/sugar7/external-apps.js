(function(app){var findDashboardPreviewLayout=function(meta,layoutName,targetLayout,layoutMeta){if(meta.name&&meta.name===layoutName){targetLayout=meta;return targetLayout;}
if(_.isArray(meta)){var len=meta.length;for(var i=0;i<len;i++){if(_.isArray(meta[i])||_.isObject(meta[i])){targetLayout=findDashboardPreviewLayout(meta[i],layoutName,targetLayout,layoutMeta);}
if(!_.isEmpty(targetLayout)){return targetLayout;}}}else{for(var prop in meta){if(_.isArray(meta[prop])||_.isObject(meta[prop])){targetLayout=findDashboardPreviewLayout(meta[prop],layoutName,targetLayout,layoutMeta);if(!_.isEmpty(targetLayout)){return targetLayout;}}}}};var addCompToLayout=function(metadata,targetModule,targetLayout,def,fieldsToAdd){var modMeta=metadata.modules[targetModule];var layoutPieces=targetLayout.split('-');var hasLayoutInModule;var dashPrevLayout;var meta;var layoutName;var view;if(def.view.name&&def.view.name.indexOf('LBL_')!==-1){def.view.name=app.lang.get(def.view.name,targetModule);}
if(def.view.description&&def.view.description.indexOf('LBL_')!==-1){def.view.description=app.lang.get(def.view.description,targetModule);}
if(modMeta){modMeta.layouts=modMeta.layouts||{};meta=modMeta.layouts[targetLayout];hasLayoutInModule=!!meta;if(layoutPieces.length===2&&_.contains(['record','list','multiline'],layoutPieces[0])&&layoutPieces[1]==='field'){var layoutName=_fixViewName(layoutPieces[0]);var layoutEventName=layoutName==='list'?'recordlist':layoutName;if(layoutName&&_.isUndefined(modMeta.views[layoutName])){return;}
view=modMeta.views[layoutName];_.each(fieldsToAdd,function(field){field.src=def.view.src;var metaField=_findFieldInMeta(field,view);if(metaField){_.extend(metaField,field);}else if(!_.isUndefined(field.panelIndex)&&!_.isUndefined(field.fieldIndex)){_spliceFieldIntoMeta(field,view,field.panelIndex,field.fieldIndex);view.meta.hasExternalFields=true;}},this);app.events.trigger('sugarApp:'+targetModule+':'+layoutEventName+':updated',fieldsToAdd);}else if(layoutPieces.length===2&&(layoutPieces[1]==='dashboard'||layoutPieces[1]==='preview')){layoutName=layoutPieces[0]==='list'?'records':'record';meta=app.metadata.getLayout(targetModule,layoutName);dashPrevLayout=findDashboardPreviewLayout(meta,layoutPieces[1]+'-pane',{});if(dashPrevLayout){dashPrevLayout.components.push(def);if(!modMeta.layouts[layoutName]){modMeta.layouts[layoutName]={};}
if(!modMeta.layouts[layoutName].meta){modMeta.layouts[layoutName].meta={};}
if(!modMeta.layouts[layoutName].meta.components){modMeta.layouts[layoutName].meta.components=[];}
metadata.modules[targetModule].layouts[layoutName].meta.components=meta.components;App.metadata.set(metadata);}else{App.logger.warn('The '+layoutName+' layout for the '+targetModule+' does not contain a '+
layoutPieces[1]+'-pane component inside the layout.');}}else if(!hasLayoutInModule){modMeta.layouts[targetLayout]={meta:app.metadata.getLayout('',targetLayout)||{components:[]}};modMeta.layouts[targetLayout].meta.components.push(def);app.events.trigger('sugarApp:'+targetModule+':'+targetLayout+':updated');}else{if(!meta.meta){meta.meta={};}
if(!meta.meta.components){meta.meta.components=[];}
meta.meta.components.push(def);}}};var _findFieldInMeta=function(fieldDef,viewMeta){var found=null;if(_.isUndefined(fieldDef)||_.isUndefined(viewMeta)){return null;}
_.some(viewMeta.meta.panels,function(panel){return _.some(panel.fields,function(metaField){if(metaField.subfields){return _.some(metaField.subfields,function(subField){if(subField.name===fieldDef.name){found=subField;return true;}});}else if(metaField.name===fieldDef.name){found=metaField;return true;}});});return found;};var _fixViewName=function(name){var nameMap={multiline:'multi-line-list',};return nameMap[name]||name;};var _spliceFieldIntoMeta=function(fieldDef,viewMeta,panelIndex,fieldIndex){var panels=viewMeta.meta.panels;var panel=panelIndex>panels.length?panels[panels.length-1]:panels[panelIndex];var fields=panel.fields;delete fieldDef.panelIndex;delete fieldDef.fieldIndex;if(fieldIndex<fields.length){fields.splice(fieldIndex,0,fieldDef);}else{fields.push(fieldDef);}};app.metadata.addSyncTask(function(metadata,options){if(!app.config.catalogEnabled){return;}
var catalogUrl=app.config.catalogUrl;if(options.getPublic){return Promise.resolve();}
if(catalogUrl&&catalogUrl!==''&&_.isString(catalogUrl)){if(!(catalogUrl.indexOf('http://')===0||catalogUrl.indexOf('https://')===0)){catalogUrl='https://'+catalogUrl;}
catalogUrl=catalogUrl.match(/^.+\:\/\/[^\/]+/)[0]+'/catalog?isAuthorized=true';var getCatalog=function(onSuccess,onError,onLogin){$.ajax({url:catalogUrl,headers:{'X-IDM-ACCESS-TOKEN':app.api.getOAuthToken()},xhrFields:{withCredentials:true,cors:true},contentType:'application/json; charset=utf-8',dataType:'json',crossDomain:true,success:function(catalog){if(catalog.loginRedirect&&onLogin){onLogin(catalog.loginRedirect);}else{onSuccess(catalog);}},error:function(error){onError(error);}});};var addCatalogToLayout=function(catalog){if(!catalog||!catalog.layouts){return;}
_.each(catalog.layouts,function(def){if(def.module&&def.layout){catalog.type='external-app';addCompToLayout(metadata,def.module,def.layout,{view:catalog},def.fields);}});};var updateManifest=function(catalog){if(catalog.customValidityCheck){return System.import(catalog.src).then(function(mod){var props=Object.getOwnPropertyNames(mod).filter(function(name){return name.substr(0,2)!=='__';});if(mod.default&&(props.length===1||mod.__useDefault)){mod=mod.default;}
return mod.updateManifest(catalog);}).then(function(result){if(_.isObject(result)){return result;}else if(result){return catalog;}else{return null;}}).catch(function(err){console.error('Failed to test module validity',err);return null;});}else{return Promise.resolve(catalog);}};return new Promise(function(res,error){var serverInfo=App.metadata.getServerInfo();var fetchAppLayout=function(app){$.ajax({url:app.src,dataType:'json',data:{flavor:serverInfo.flavor,tenantId:App.config.tenant,version:serverInfo.version,licenses:App.user.attributes.licenses},xhrFields:{withCredentials:true},crossDomain:true,contentType:'application/json; charset=utf-8',mode:'cors',success:function(catalog){updateManifest(catalog).then(function(manifest){if(manifest.apps){_.each(manifest.apps,function(app){var catEntry=_.pick(manifest,'clientFileName','scope','src','srn','version');catEntry=_.extend(catEntry,app);updateManifest(catEntry).then(addCatalogToLayout);},this);}else{addCatalogToLayout(manifest);}});},error:function(error){console.error(error);}});};var handleCatalog=function(catalog){_.each(catalog.apps,function(app){fetchAppLayout(app);});res();};var onError=function(err){app.logger.error(err.message);res();};getCatalog(handleCatalog,onError,function(loginUrl){var iframe=document.createElement('iframe');var cleanup=function(){iframe.parentElement.removeChild(iframe);window.removeEventListener('message',eventCallback);};var eventCallback=function(event){var iframeOrigin=window.location.href.match(/^.+\:\/\/[^\/]+/)[0];if(event.origin===iframeOrigin){cleanup();getCatalog(handleCatalog,onError,function(url){var err='Unable to authenticate with catalog service: Second Login URL:'+url;app.logger.error(err);res();});}};iframe.onload=function(){console.log('loaded before we got the event ',arguments);cleanup();res();};iframe.src=loginUrl;iframe.style='display:none;\n'+'position: absolute;\n'+'width: 500px;\n'+'height: 500px;\n'+'top: calc(50% - 250px);\n'+'left: calc(50% - 250px);';window.addEventListener('message',eventCallback);document.body.appendChild(iframe);});});}
return Promise.resolve();});})(SUGAR.App);