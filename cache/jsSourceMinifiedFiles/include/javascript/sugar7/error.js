(function(app){app.error=_.extend(app.error);function backToLogin(bDismiss){if(bDismiss){app.alert.dismissAll();}
if(app.api.isAuthenticated()){app.api.resetAuth();}
app.trigger('app:logout');app.router.login();}
function showErrorPage(status,dismiss){if(dismiss){app.alert.dismissAll();}
app.controller.loadView({layout:"error",errorType:status,module:"Error",create:true});}
function processAuthenticatedUserError(key,title,msg){var isAuthenticated=app.api.isAuthenticated();backToLogin(true);if(isAuthenticated){alertUser(key,title,msg);}}
function alertUser(key,title,msg){app.alert.show(key,{level:'error',messages:app.lang.get(msg),title:app.lang.get(title)});}
app.events.on('app:sync:error',function(error){if(error.status!==0){if(app.config.idmModeEnabled&&error.code==='idm_nonrecoverable_error'){return;}
backToLogin(true);}
alertUser('sync_failure','ERR_SYNC_FAILED',(error&&error.message)||'LBL_INVALID_412_RESPONSE');});app.events.on('app:sync:public:error',function(error){app.alert.dismissAll();alertUser('public_sync_failure','Unable to load the application.');});app.error.handleNeedLoginError=function(error){backToLogin(true);alertUser('needs_login_error','LBL_INVALID_CREDS_TITLE',error.message);};app.error.handleInvalidGrantError=function(error){processAuthenticatedUserError('invalid_grant_error','LBL_INVALID_GRANT_TITLE','LBL_INVALID_GRANT');};app.error.handleInvalidClientError=function(error){backToLogin(true);alertUser("invalid_client_error","LBL_AUTH_FAILED_TITLE","LBL_AUTH_FAILED");};app.error.handleInvalidRequestError=function(error){backToLogin(true);alertUser("invalid_request_error","LBL_INVALID_REQUEST_TITLE","LBL_INVALID_REQUEST");};app.error.handleUnspecified400Error=function(error){showErrorPage('400');};app.error.handleTimeoutError=function(error){app.alert.dismissAll();alertUser("timeout_error","LBL_REQUEST_TIMEOUT_TITLE","LBL_REQUEST_TIMEOUT");};app.error.handleUnauthorizedError=function(error){if(app.config.idmModeEnabled&&error.code==='idm_nonrecoverable_error'){app.alert.dismissAll();app.router.logout();alertUser('unauthorized_request_error','LBL_UNAUTHORIZED_TITLE','LBL_UNAUTHORIZED');}else{processAuthenticatedUserError('unauthorized_request_error','LBL_UNAUTHORIZED_TITLE','LBL_UNAUTHORIZED');}};app.error.handleForbiddenError=function(error){var message;if(error.code!="not_authorized"){app.alert.dismissAll();}
if(error.code=="portal_not_configured"){backToLogin(true);}
message=Handlebars.Utils.escapeExpression(error.message)||"LBL_RESOURCE_UNAVAILABLE";app.logger.error(app.lang.get(message));};app.error.handleNotFoundError=function(error,model,options){var layout=app.controller.layout||{};if((options&&options.context!=layout.context)||(model&&layout.context&&layout.context.get("model")&&layout.context.get("model")!=model)){return;}
if(!layout||!_.isObject(layout.error)||!_.isFunction(layout.error.handleNotFoundError)||layout.error.handleNotFoundError(error,model,options)!==false){showErrorPage("404");}};app.error.handleMethodNotAllowedError=function(error){backToLogin(true);alertUser("not_allowed_error","LBL_METHOD_NOT_ALLOWED_TITLE","LBL_METHOD_NOT_ALLOWED");};app.error.handleMethodConflictError=function(error){app.logger.error('Data conflict detected.');};app.error.handleValidationError=function(error){var layout=app.controller.layout,message;if(!_.isObject(layout.error)||!_.isFunction(layout.error.handleValidationError)||layout.error.handleValidationError(error)!==false){if(error instanceof app.data.beanModel){return;}
message=Handlebars.Utils.escapeExpression(error.message)||"LBL_PRECONDITION_MISSING";alertUser("validation_error","LBL_PRECONDITION_MISSING_TITLE",message);error.handled=true;}};app.error.handleHeaderPreconditionFailed=function(error,b,c,d){if(!app.isSynced){return;}
if(!error||error.code!=='metadata_out_of_date'){return;}
var responseText=JSON.parse(error.responseText);var newHash=responseText&&responseText.metadata_hash;var userHash=responseText&&responseText.user_hash;var afterSync=error.request.state&&error.request.state.loadingAfterSync;var sentHash=error.request.params.headers['X-Metadata-Hash'];var sentUserHash=error.request.params.headers['X-Userpref-Hash'];var currentHash=app.metadata.getHash();var currentUserHash=app.user.get('_hash');if(((!newHash&&afterSync)||(newHash===currentHash&&sentHash===currentHash))&&((!userHash&&afterSync)||(userHash===currentUserHash&&sentUserHash===currentUserHash))){app.logger.fatal('A request returned the error code "metadata_out_of_date" for no reason.');app.alert.show('invalid_412',{level:'error',messages:['LBL_INVALID_412_RESPONSE']});app.api.resetAuth();app.router.refresh();return;}
app.sync();};app.error.handleMethodFailureError=function(error){error.handled=true;if(error.code=="request_failure"){showErrorPage("422");}else{alertUser("precondtion_failure_error","LBL_PRECONDITION_MISSING_TITLE","LBL_PRECONDITION_MISSING");}};app.error.handleServerError=function(error){if(error.payload&&error.payload.url){if(app.acl.hasAccess('admin','Administration')){app.router.navigate(error.payload.url,{trigger:true,replace:true});return;}}
app.controller.loadView({layout:"error",errorType:error.status||"500",module:"Error",error:error,create:true});};})(SUGAR.App);