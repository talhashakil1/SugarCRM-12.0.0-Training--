(function(app){var Bwc={login:function(redirectUrl,callback){var url=app.api.buildURL('oauth2','bwc/login');return app.api.call('create',url,{},{success:function(data){if(data&&data.name){app.cache.set('SessionName',data.name);}
if(callback){callback();}
if(redirectUrl){if(redirectUrl.indexOf('&bwcRedirect=1')>-1){app.error.handleInvalidClientError();}else{app.router.navigate('#bwc/'+redirectUrl+'&bwcRedirect=1',{trigger:true});}}}});},logout:function(callback){let url=app.api.buildURL('oauth2','bwc/logout');return app.api.call('create',url,{},{success:function(data){if(callback){callback(data);}}});},getAction:function(action){var bwcActions={'create':'EditView','edit':'EditView','detail':'DetailView'};return bwcActions[action]||action;},buildRoute:function(module,id,action,params){var href='bwc/index.php?',params=_.extend({},{module:module},params);if(!action&&!id||action==='DetailView'&&!id){params.action='index';}else{if(action){params.action=action;}else{params.action='DetailView';}
if(id){params.record=id;}}
return href+$.param(params);},_createRelatedRecordUrlParams:function(parentModel,link){var params={parent_type:parentModel.module,parent_name:parentModel.get('name')||parentModel.get('full_name')||app.utils.formatNameLocale(parentModel.attributes),parent_id:parentModel.get("id"),return_module:parentModel.module,return_id:parentModel.get("id"),return_name:parentModel.get('name')||parentModel.get('full_name')||app.utils.formatNameLocale(parentModel.attributes)};var linkField=_.find(parentModel.fields,function(field){return(field.type=='link'&&field.name==link)});if(linkField){params['return_relationship']=linkField.relationship;}
params=this._handleRelatedRecordSpecialCases(params,parentModel,link);var fields=app.data.getRelateFields(parentModel.module,link);_.each(fields,function(field){params[field.name]=parentModel.get(field.rname)||app.utils.formatNameLocale(parentModel.attributes);params[field.id_name]=parentModel.get("id");if(field.populate_list){_.each(field.populate_list,function(target,source){source=_.isNumber(source)?target:source;if(!_.isUndefined(parentModel.get(source))){params[target]=parentModel.get(source);}},this);}});return params;},_handleRelatedRecordSpecialCases:function(params,parentModel,link){var syncedAttributes=parentModel.getSynced();if(parentModel.module=='Contacts'&&parentModel.has('account_id')&&(link=='meetings'||link=='calls')){params=_.extend(params,{parent_type:'Accounts',parent_id:syncedAttributes.account_id||parentModel.get('account_id'),account_id:syncedAttributes.account_id||parentModel.get('account_id'),account_name:syncedAttributes.account_name||parentModel.get('account_name'),parent_name:syncedAttributes.account_name||parentModel.get('account_name'),contact_id:syncedAttributes.id||parentModel.get('id'),contact_name:syncedAttributes.full_name||parentModel.get('full_name')});}
if(link=='quotes'||link=='contracts'){if(parentModel.has('account_id')){params=_.extend(params,{account_id:syncedAttributes.account_id||parentModel.get('account_id'),account_name:syncedAttributes.account_name||parentModel.get('account_name')});}
if(parentModel.module==='Contacts'){params=_.extend(params,{contact_id:parentModel.get('id')});}else if(parentModel.has('contact_id')){params=_.extend(params,{contact_id:syncedAttributes.contact_id||parentModel.get('contact_id')});}}
return params;},createRelatedRecord:function(module,parentModel,link,id){var params=this._createRelatedRecordUrlParams(parentModel,link);var route=app.bwc.buildRoute(module,id||null,"EditView",params);app.router.navigate("#"+route,{trigger:true});},shareRecord:function(module,id,name){var containerView=app.view.createView({});var shareField=app.view.createField({def:{type:'shareaction'},module:module,model:app.data.createBean(module,{id:id,name:name}),view:containerView});if(shareField.useSugarEmailClient()){shareField.shareWithSugarEmailClient();}else{this._launchExternalEmail(shareField.getShareMailtoUrl());}
containerView.dispose();},_launchExternalEmail:function(mailto){var tempMailTo=$('<a href="'+mailto+'"></a>').appendTo('body');tempMailTo.get(0).click();tempMailTo.remove();},revertAttributes:function(){var view=app.controller.layout.getComponent('bwc');if(!view){return;}
view.revertBwcModel();}};app.augment('bwc',_.extend(Bwc,Backbone.Events),false);})(SUGAR.App);