(function(app){var animationSpeed=500;var scrollOffset=25;var scrollViewReduction=75;app.augment('tutorial',{instance:null,hasTutorial:function(layout,module){module=module||app.controller.context.get('module');layout=layout||app.controller.context.get('layout');var meta=app.metadata.getModule(module);var defaultMeta=app.metadata.getView('','tutorial');if(defaultMeta){this.data=defaultMeta;}
if(meta&&meta.views&&meta.views.tutorial&&meta.views.tutorial.meta&&meta.views.tutorial.meta[layout]){return true;}else if(this.data&&this.data[layout]){return true;}else{return false;}},show:function(name,params){if(app.tutorial.data){this.doTutorial(name,params);}else if(app.metadata.getView('','tutorial')){app.tutorial.data=app.metadata.getView('','tutorial');this.doTutorial(name,params);}},doTutorial:function(name,params){var tutorialData=app.tutorial.data[name];var prefKey=name;if(params&&params.module){var meta=app.metadata.getModule(params.module);if(meta.views&&meta.views.tutorial&&meta.views.tutorial.meta&&meta.views.tutorial.meta[name]){tutorialData=meta.views.tutorial.meta[name];prefKey=name+params.module;}}
var prefs=this.getPrefs();if(tutorialData&&(!prefs.skipVersion[prefKey]||prefs.skipVersion[prefKey]<tutorialData.version)&&(!prefs.viewedVersion[prefKey]||prefs.viewedVersion[prefKey]<tutorialData.version)){params=_.extend(tutorialData,{type:'Tutorial'});app.tutorial.instance=app.view.createView(params);app.tutorial.instance.show();prefs.viewedVersion[prefKey]=tutorialData.version;app.cache.set('tutorialPrefs',prefs);}},getPrefs:function(){var prefs=app.cache.get('tutorialPrefs')||{};prefs.viewedVersion=prefs.viewedVersion||{};prefs.skipVersion=prefs.skipVersion||{};return prefs;},resetPrefs:function(prefs){prefs=prefs||{};prefs.viewedVersion={};prefs.skipVersion={};app.cache.set('tutorialPrefs',prefs);},skipTutorial:function(){var prefs=this.getPrefs();_.each(app.tutorial.data,function(data,name){prefs.skipVersion[name]=app.tutorial.data[name].version;});app.user.setPreference('tutorialPrefs',prefs);}});app.view.TutorialView=app.view.View.extend({events:{'click .btn.disabled':function(e){return false;},'click .back-btn:not(.disabled)':'back','click .next-btn:not(.disabled)':'next','click .done-btn':'hide','swipeLeft':'onSwipeLeft'},_duringAnimate:false,initialize:function(options){options=_.extend({},options||{});this.index=0;this.setIntro(options.intro);this.setContent(options.content);this.setScroll(options.scroll);app.events.on('app:login app:logout',this.hide,this);},setContent:function(content){this.content=content;},setIntro:function(intro){this.intro=intro;},setScroll:function(scroll){this.scroll=scroll;},reset:function(){this.index=0;},onSwipeLeft:function(e){app.tutorial.skipTutorial();this.hide(e);},show:function(options){options=_.extend({},options||{});if(options.content){this.setContent(options.content);}
if(options.intro){this.setIntro(options.intro);}
if(options.scroll){this.setScroll(options.scroll);}
if(options.reset){this.reset();}
this.render();if(this.intro&&!this.introShown){this.index=-1;this.introShown=true;this.showMessageOnly(this.intro);}else{this.highlightItem(this.index);}},hide:function(event){if(event){event.preventDefault();}
this.dispose();},back:function(event){if(event){event.preventDefault();}
if(this._duringAnimate){return;}
this.highlightItem(this.index-1);},next:function(event){if(event){event.preventDefault();}
if(this._duringAnimate){return;}
this.highlightItem(this.index+1);},highlightItem:function(index){var self=this;if(index<0){return;}
if(index>=this.content.length){this.hide();return;}
var content=this.content[index];if(!content.name){this.showMessageOnly(content.text);}else{var item=$(content.name);var direction=this.index>index?-1:1;if((item.length===0||item.css('display')==='none')||item.parents('.hide').length>0){return this.highlightItem(index+direction);}
var highlightCallback=function(){if(!this.highlight){this.highlight=$('<div/>');this.highlight.attr('id','highlight');this.highlightText=$('<div/>');this.highlightText.attr('id','highlight-text');this.highlight.html(this.highlightText);$('#tutorial-content').html(this.highlight);}
this.highlightText.hide();this.hideGlow();this._duringAnimate=true;this.highlight.animate({'top':item.offset().top+(content.vertAdj||0),'left':item.offset().left+(content.horizAdj||0),'width':content.full?item.offset().width:'','height':content.full?item.offset().height:''},animationSpeed,'linear',function(){self._duringAnimate=false;if(content.glow===undefined||content.glow!==false){self.showGlow();}
self.showHighlightText(content.text);});};highlightCallback=_.bind(highlightCallback,this);this.scrollToEl(item,highlightCallback);}
if(index<=0){this.$el.find('.back-btn').addClass('disabled');}else{this.$el.find('.back-btn').removeClass('disabled');}
if(index>=(this.content.length-1)){this.$el.find('.next-btn').addClass('disabled');}else{this.$el.find('.next-btn').removeClass('disabled');}
this.index=index;},showGlow:function(){this.$el.find('#mask').css('background-image','-webkit-radial-gradient('+(this.highlight.offset().left+(this.highlight.width()/ 2))+'px '+
(this.highlight.offset().top+(this.getTotalHeight(this.highlight)/ 2))+'px , '+
this.highlight.width()+'px '+this.highlight.height()+'px, transparent, black '+Math.max(this.highlight.width(),this.highlight.height())+'px)');this.$el.find('#mask').css('background','radial-gradient(circle closest-side at '+(this.highlight.offset().left+(this.highlight.width()/ 2))+'px '+
(this.highlight.offset().top+(this.getTotalHeight(this.highlight)/ 2))+'px , '+' transparent 0%, black '+Math.max(this.highlight.width(),this.highlight.height())+'px)');this.$el.find('#mask').css('background-color','transparent');},hideGlow:function(){this.$el.find('#mask').css('background-color','');this.$el.find('#mask').css('background-image','');},showHighlightText:function(message){var top;var highlightBorderOffset;this.highlightText.html(app.lang.get(message,app.controller.context.get('module')));this.highlightText.show();if(this.highlight.offset().left-this.getTotalWidth(this.highlightText)>0&&this.findIntersectors([this.highlight.offset().left-this.getTotalWidth(this.highlightText),this.highlight.offset().left],[this.highlight.offset().top+(this.getTotalHeight(this.highlight)/ 2)-(this.getTotalHeight(this.highlightText)/ 2),this.highlight.offset().top+(this.getTotalHeight(this.highlight)/ 2)-(this.getTotalHeight(this.highlightText)/ 2)+this.getTotalHeight(this.highlightText)],'.btn-group').length===0){highlightBorderOffset=parseInt(this.highlight.css('border-left-width'));this.highlightText.css('left',0-(this.getTotalWidth(this.highlightText)+highlightBorderOffset));top=(this.getTotalHeight(this.highlight)/ 2)-(this.getTotalHeight(this.highlightText)/ 2);this.highlightText.css('top',top>=0?top:0);this.highlightText.css('text-align','right');}else if(this.highlight.offset().left+this.getTotalWidth(this.highlight)+this.getTotalWidth(this.highlightText)<$(window).width()&&this.findIntersectors([this.highlight.offset().left+this.getTotalWidth(this.highlight),this.highlight.offset().left+this.getTotalWidth(this.highlight)+this.getTotalWidth(this.highlightText)],[this.highlight.offset().top+(this.getTotalHeight(this.highlight)/ 2)-(this.getTotalHeight(this.highlightText)/ 2),this.highlight.offset().top+(this.getTotalHeight(this.highlight)/ 2)-(this.getTotalHeight(this.highlightText)/ 2)+this.getTotalHeight(this.highlightText)],'.btn-group').length===0){highlightBorderOffset=parseInt(this.highlight.css('border-right-width'));this.highlightText.css('left',this.getTotalWidth(this.highlight)+highlightBorderOffset);top=(this.getTotalHeight(this.highlight)/ 2)-(this.getTotalHeight(this.highlightText)/ 2);this.highlightText.css('top',top>=0?top:0);this.highlightText.css('text-align','left');}else{var newLeftVal=(this.getTotalWidth(this.highlight)/ 2)-(this.getTotalWidth(this.highlightText)/ 2);var leftEdge=this.highlight.offset().left+newLeftVal;newLeftVal=leftEdge<0?0-this.highlight.offset().left:newLeftVal;var rightEdge=this.highlight.offset().left+newLeftVal+this.getTotalWidth(this.highlightText);newLeftVal=rightEdge>$(window).width()?newLeftVal-(rightEdge-$(window).width()):newLeftVal;var newTopVal;if(this.highlight.offset().top+this.getTotalHeight(this.highlight)+this.getTotalHeight(this.highlightText)<$(window).height()&&this.findIntersectors([this.highlight.offset().left+newLeftVal,this.highlight.offset().left+newLeftVal+this.getTotalWidth(this.highlightText)],[this.highlight.offset().top+this.getTotalHeight(this.highlight),this.highlight.offset().top+this.getTotalHeight(this.highlight)+this.getTotalHeight(this.highlightText)],'.btn-group').length===0){newTopVal=this.getTotalHeight(this.highlight);}else{newTopVal=-5-this.getTotalHeight(this.highlightText);}
this.highlightText.css('left',newLeftVal);this.highlightText.css('top',newTopVal);this.highlightText.css('text-align','center');}},findIntersectors:function(tX,tY,intersectorsSelector){var intersectors=[];var self=this;this.$el.find(intersectorsSelector).each(function(){var $this=$(this);var thisPos=$this.offset();var iX=[thisPos.left,thisPos.left+self.getTotalWidth($this)];var iY=[thisPos.top,thisPos.top+self.getTotalHeight($this)];if(tX[0]<iX[1]&&tX[1]>iX[0]&&tY[0]<iY[1]&&tY[1]>iY[0]){intersectors.push($this);}});return intersectors;},showMessageOnly:function(message){$('#tutorial-content').html("<div class='text-container'><div class='text'>"+
app.lang.get(message,app.controller.context.get('module'))+'</div></div>');this.highlight=null;this.hideGlow();},getTotalWidth:function(el){var totalWidth=el.width();totalWidth+=parseInt(el.css('padding-left'),10)+parseInt(el.css('padding-right'),10);totalWidth+=parseInt(el.css('margin-left'),10)+parseInt(el.css('margin-right'),10);return totalWidth;},getTotalHeight:function(el){var totalHeight=el.height();totalHeight+=parseInt(el.css('padding-top'),10)+parseInt(el.css('padding-bottom'),10);totalHeight+=parseInt(el.css('margin-top'),10)+parseInt(el.css('margin-bottom'),10);return totalHeight;},scrollToEl:function($targetEl,callback){var viewportHeight=$(window).height();var elTop=$targetEl.offset().top;var elHeight=$targetEl.height();var headerHeight=($('.navbar').height()+3)||0;var footerHeight=$('footer').height()||0;var buffer=125;var direction;if($.contains('.navbar',$targetEl)){headerHeight=0;}
if($.contains('footer',$targetEl)){footerHeight=0;}
if(elTop+elHeight>window.pageYOffset+viewportHeight-footerHeight){direction='down';buffer*=-1;}else if(elTop+elHeight<window.pageYOffset+elHeight+headerHeight){direction='up';}else{direction='none';if(callback&&_.isFunction(callback)){callback();}}
if(direction!=='none'){$('#content, .main-pane, .side-pane').animate({scrollTop:elTop+buffer},{duration:'fast',complete:function(){if(callback&&_.isFunction(callback)){callback();}}});}},render:function(){var tutorial=app.template.get('tutorial');$('body').append(tutorial());app.$contentEl.attr('aria-hidden',true);this.$el=$('#tutorial');this.delegateEvents();this.$el.show();return this;},remove:function(){app.$contentEl.removeAttr('aria-hidden');if(app.tutorial.instance===this){app.tutorial.instance=null;}
if(this.highlight){this.highlight.stop(true,true);}
delete this.highlight;delete this.highlightText;Backbone.View.prototype.remove.call(this);}});})(SUGAR.App);