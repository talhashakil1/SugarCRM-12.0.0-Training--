(function(app){app.events.on('app:init',function(){app.utils=_.extend(app.utils,{'GlobalSearch':{formatRecords:function(collection,linkableHighlights){collection.each(function(model){if(model.formatted){return;}
var highlights=model.get('_highlights');if(!highlights){model.formatted=true;return;}
var moduleMeta=app.metadata.getModule(model.get('_module'));var nameFormatValues=_.values(moduleMeta.nameFormat);if(nameFormatValues.length){var personAttrs=_.pick(model.attributes,nameFormatValues);_.each(personAttrs,function(val,key){personAttrs[key]=Handlebars.Utils.escapeExpression(val);});if(!highlights.full_name){var fullname=app.utils.formatNameModel(model.get('_module'),_.extend({},personAttrs,highlights));if(fullname.length){highlights.name=[fullname];}
highlights=_.omit(highlights,_.keys(personAttrs));}}
var formattedHighlights=_.map(highlights,function(val,key){if(key==='email'){if(val.primary){val=new Handlebars.SafeString(_.first(val.primary));var label='LBL_PRIMARY_EMAIL';}else{return false;}}else if(key==='commentlog'){if(val.commentlog_entry){val=new Handlebars.SafeString(_.first(val.commentlog_entry));}else{return false;}}else{val=new Handlebars.SafeString(_.first(val));}
return{name:key,value:val,label:label||moduleMeta.fields[key].vname,link:linkableHighlights,highlighted:true};});formattedHighlights=_.reject(formattedHighlights,function(highlight){return highlight===false;});var highlightedSecondaryEmail=highlights.email?highlights.email.secondary:null;if(highlightedSecondaryEmail){formattedHighlights.push({name:'secondaryEmail',type:'email',value:new Handlebars.SafeString(highlightedSecondaryEmail.join(', ')),label:moduleMeta.fields.email.vname,link:linkableHighlights,highlighted:true});}
model.set('_highlights',formattedHighlights);model.formatted=true;});},getFieldsMeta:function(module,options){options=options||{};var fieldsMeta={};var meta=_.extend({},this.meta,app.metadata.getView(module,'search-list'));_.each(meta.panels,function(panel){if(panel.name==='primary'){fieldsMeta.primaryFields=this._setFieldsCategory(panel.fields,'primary',options);}else if(panel.name==='secondary'){fieldsMeta.secondaryFields=this._setFieldsCategory(panel.fields,'secondary',options);}},this);fieldsMeta.rowactions=meta.rowactions;return fieldsMeta;},_setFieldsCategory:function(fields,category,options){var fieldList={};_.each(fields,function(field){if(!fieldList[field.name]){fieldList[field.name]=_.extend({},fieldList[field.name],field);}
fieldList[field.name][category]=true;fieldList[field.name].ellipsis=false;if(category==='primary'&&options.linkablePrimary===false){fieldList[field.name].link=false;}
if(category==='secondary'){fieldList[field.name].link=false;if(field.type==='email'){fieldList[field.name].emailLink=false;}}});return fieldList;},highlightFields:function(model,viewDefs,add){var highlighted=model.get('_highlights');var varDefs=model.fields;viewDefs=_.clone(viewDefs)||{};_.each(highlighted,function(field){var hasViewDefs=viewDefs[field.name];var addOrPatchExisting=(hasViewDefs||add);if(!addOrPatchExisting){return;}
if(!_.isUndefined(model.primaryFields)&&model.primaryFields[field.name]){return;}
viewDefs[field.name]=_.extend({},varDefs[field.name],viewDefs[field.name],field);});return viewDefs;},buildSearchRoute:function(term,options){options=options||{};term=term?encodeURIComponent(term):'';var paramString='?';var firstParamDefined=false;var modules=options.modules;if(modules&&modules.length>0){paramString=paramString+'modules='+modules.join(',');firstParamDefined=true;}
var tags=options.tags;if(tags&&tags.length>0){if(firstParamDefined){paramString=paramString+'&'}
var encodedTags=_.map(tags,function(tag){return encodeURIComponent(tag);});paramString=paramString+'tags='+encodedTags.join(',');}
return app.router.buildRoute('search',term+paramString);}}});});})(SUGAR.App);