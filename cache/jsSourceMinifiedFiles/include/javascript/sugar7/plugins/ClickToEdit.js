(function(app){app.events.on('app:init',function(){app.plugins.register('ClickToEdit',['view','field'],{isView:false,isField:false,_viewCurrentIndex:-1,_viewCurrentCTEList:[],_fieldCanEdit:false,_fieldIsInEdit:false,_fieldErrorMessage:'',_fieldIsErrorState:false,isHiding:false,fieldTypeValidationMap:{datapoint:'currency'},onAttach:function(component,plugin){if(component instanceof app.view.Field){this.isField=true;this._fieldOnAttach(component);}else if(component instanceof app.view.View){this.isView=true;this._viewOnAttach(component);}},_viewOnAttach:function(component){this.once('init',function(){this.context.on('field:editable:click',this._viewHandleClickIndex,this);$(window).on('keydown.'+this.cid,_.bind(function(e){if(this.layout.isVisible()){this._viewHandleKeyDown(e);}},this));this.on('render',this._viewResetCTEList,this);},this);},_fieldOnAttach:function(component){this.events=_.extend(this.events,{'mouseenter div.clickToEdit':'_fieldShowClickToEdit','mouseleave div.clickToEdit':'_fieldHideClickToEdit','click div.clickToEdit':'_fieldHandleFieldClick'});this.once('init',_.bind(function(){if(this._fieldCheckIfCanEdit()){this._fieldBindPluginEvents();}
this.listenTo(this,'render',()=>{if(this.options.highlightChangedValues){this._highlightChanges();}});},this));},onDetach:function(component,plugin){if(this.isField){this._fieldOnDetach(component);}else if(this.isView){this._viewOnDetach(component);}},_viewOnDetach:function(component){this.context.off('field:editable:click');$(window).off('keydown.'+this.cid);},_fieldOnDetach:function(component){$(document).off('mousedown.record'+this.cid);},_viewHandleKeyDown:function(evt){if(evt.which===9){evt.preventDefault();var $elem=$(evt.target),isValid,field=this.fields[$(this._viewCurrentCTEList[this._viewCurrentIndex]).attr('sfuuid')],val;if(field&&field.type==='enum'){val=field.$(field.fieldTag).select2('val');}else{val=$elem.val();}
if(!evt.shiftKey){if(this._viewCurrentIndex!==-1&&this._viewCurrentIndex+1<this._viewCurrentCTEList.length){isValid=this._fieldDoValidate($elem,val);if(isValid){$elem.parents('.isEditable').removeClass('error');this._viewCurrentIndex++;}else{$elem.parents('.isEditable').addClass('error');}}else{this._viewCurrentIndex=0;}}else{if(this._viewCurrentIndex-1>=0){isValid=this._fieldDoValidate($elem,val);if(isValid){$elem.parents('.isEditable').removeClass('error');this._viewCurrentIndex--;}else{$elem.parents('.isEditable').addClass('error');}}else{this._viewCurrentIndex=this._viewCurrentCTEList.length-1;}}
this.$(this._viewCurrentCTEList[this._viewCurrentIndex]).find('div.clickToEdit').click();}},_viewResetCTEList:function(){var oldLength=this._viewCurrentCTEList.length;this._viewCurrentCTEList=this.$('.isEditable');if(oldLength>this._viewCurrentCTEList.length){this._viewCurrentIndex--;}},_viewHandleClickIndex:function(field){_.find(this._viewCurrentCTEList,function(el,idx,list){var $el=$(el);if(_.isEqual($el.find('div.clickToEdit').data('cid'),field.cid)){this._viewCurrentIndex=idx;return true;}},this);},_fieldBindPluginEvents:function(){this.context.on('field:editable:open',function(cid){if(this._fieldIsErrorState){this.context.trigger('field:editable:error',this.cid);}else{if(this._fieldIsInEdit&&this.cid!==cid){if(this.type==='enum'){this.$('select').select2('close');}
if(this.type!='date'){this.setMode('list');}}}},this);this.context.on('field:editable:error',function(cid){if(!_.isEqual(cid,this.cid)&&this.options.viewName==='edit'){this.setMode('list');}},this);this.on('render',function(){var cteClass='clickToEdit';let el=this.$el;if(this.cteTag){el=this.$el.find(this.cteTag);}
if(this.action==='edit'){cteClass+=' active';el.addClass('active');}else{el.removeClass('active');}
if(!el.hasClass('disabled')&&!this.disableCTE){el.addClass('isEditable');el.wrapInner('<div class="'+cteClass+'" data-cid="'+this.cid+'" />');}},this);if(this.context.parent){this.context.parent.on('change:selectedUser',function(){if(this._fieldIsErrorState){this.clearErrorDecoration();}},this);}},_fieldCheckIfCanEdit:function(){var isEnforced=(!_.isUndefined(this.def.enforced)&&this.def.enforced===true),isClickToEdit=(!_.isUndefined(this.def.click_to_edit)&&this.def.click_to_edit===true);if(!isEnforced&&isClickToEdit){var ctx=this.context.parent||this.context,selectedUser=ctx.get('selectedUser')||app.user.toJSON();this._fieldCanEdit=_.isEqual(app.user.get('id'),selectedUser.id);this._fieldCanEdit=(this._fieldCanEdit&&app.acl.hasAccess('write',this.module,app.user.get('id'),this.name));if(this._fieldCanEdit&&this.model.has('sales_stage')){var salesStage=this.model.get('sales_stage'),disableIfSalesStageIs=_.union(app.metadata.getModule('Forecasts','config').sales_stage_won,app.metadata.getModule('Forecasts','config').sales_stage_lost);if(salesStage&&_.indexOf(disableIfSalesStageIs,salesStage)!=-1){this._fieldCanEdit=false;}}}
return this._fieldCanEdit;},_fieldBindDomChange:function(){var $el=this.$(this.fieldTag);$el.on('change',_.bind(function(){var value=this._fieldDoValidate(this,$el.val());if(value!==false){if(this._fieldIsErrorState){this.clearErrorDecoration();}
this.model.set(this.name,this.unformat(value));}else{var hb=Handlebars.compile('{{str key module context}}'),args={field_name:app.lang.get(this.def.label,this.module)};this._fieldErrorMessage=hb({'key':'LBL_EDITABLE_INVALID','module':this.module,'context':args});this._fieldShowErrors();$el.select();}},this));},_fieldShowErrors:function(){if(this._fieldIsErrorState===false){var ftag=this.fieldTag||'';var $ftag=this.$(ftag);var $tooltip;this._fieldIsErrorState=true;var ctx=this.context.parent||this.context;ctx.trigger('field:error',this,true);this.$el.addClass('error');var isWrapped=$ftag.parent().hasClass('input-append');if(!isWrapped){$ftag.wrap('<div class="input-append '+ftag+'">');}
$ftag.parent().addClass('error');$tooltip=$(this.exclamationMarkTemplate([this._fieldErrorMessage]));$ftag.after($tooltip);this.$('input').addClass('local-error');}},_fieldShowClickToEdit:function(event){if(this._fieldCanEdit&&!this._fieldIsInEdit){let target=$(event.currentTarget);let icon='<span class="edit-icon"><i class="sicon sicon-sm sicon-edit"></i></span>';if(target.has('label.original').length){target=target.find('label.original').next();}
if(target.has('div.ellipsis_inline').length){target=target.find('div.ellipsis_inline');}
target.prepend(icon);}},_fieldHideClickToEdit:function(event){if(this._fieldCanEdit&&!this._fieldIsInEdit){$(event.currentTarget).find('span.edit-icon').remove();}},_fieldHandleFieldClick:function(evt){if(this._fieldCanEdit&&!this._fieldIsInEdit){this.context.trigger('field:editable:click',this);this.setMode('edit');if(_.isFunction(this.focus)){this.focus();}else{var $el=this.$(this.fieldTag+':first');$el.focus().val($el.val()).select();}
if(this.type!=='image'){if(_.isFunction(this.bindKeyDown)){this.bindKeyDown(_.bind(this._fieldOnKeyDown,this));}else{this.$(this.fieldTag).on('keydown.record'+this.cid,{field:this},_.bind(this._fieldOnKeyDown,this));}
$(document).on('mousedown.record'+this.cid,{field:this},_.bind(this._fieldMouseClicked,this));}
if(this.type==='enum'){this.model.once('change:'+this.name,function(){_.defer(_.bind(function(){this.setMode('list');},this));},this);}
if(this.type==='date'){this.$el.closest('td').addClass('td-inline-edit');}}},_fieldOnKeyDown:function(evt){this._fieldHandleKeyDown.call(this,evt,evt.data.field);},_fieldMouseClicked:_.debounce(function(evt){this._fieldClose.call(this,evt,evt.data.field);},0),_fieldClose:function(evt,field){var currFieldParent=field.$el,targetPlaceHolder=this.$(evt.target).parents('span[sfuuid="'+field.sfId+'"]'),preventPlaceholder=this.$(evt.target).closest('.prevent-mousedown');if(preventPlaceholder.length>0||targetPlaceHolder.length>0||currFieldParent.find(':focus').length>0||!_.isEmpty(app.drawer._components)){return;}
if(this._fieldIsErrorState){this.$(this.fieldTag).focus().select();return;}
this.setMode('list');},_fieldHandleKeyDown:function(evt,field){if(field.disposed){return;}
if(evt.which===27){this.setMode('list');}else if(evt.which===13){if(this._fieldValueChanged(field)){this.model.once('change:'+field.name,function(){this.setMode('list');},this);}else{this.setMode('list');}}},_fieldValueChanged:function(field){var elVal=field.$(field.fieldTag).val();if(field.type==='currency'||field.type==='int'){elVal=this._fieldParsePercentage(elVal,(field.type==='currency')?undefined:0);}
if(field.type==='currency'){var diff=Math.abs(this.unformat(elVal)-this.unformat(field.value));return((Math.round(diff*100))!=0)}else{if(field.type==='date'){if(_.isUndefined(elVal)){elVal=field.$('div').html();}
return!_.isEqual(this.unformat(elVal),this.unformat(field.value));}else{return!_.isEqual(this.unformat(elVal),this.unformat(field.value));}}},_fieldDoValidate:function(field,newValue){let fieldType=field.type||field.data('type');fieldType=this.fieldTypeValidationMap[fieldType]||fieldType;if(_.isUndefined(newValue)||_.isEmpty(newValue)){if(_.isUndefined(this.fieldTag)){return false;}
newValue=this.$(this.fieldTag).val();}
if(fieldType==='int'){newValue=this._fieldParsePercentage(newValue,0);if(this._fieldVerifyIntValue(newValue)){return newValue;}}else{if(fieldType==='currency'){newValue=this._fieldParsePercentage(newValue);if(this._fieldVerifyCurrencyValue(newValue)){return newValue;}}else{if(fieldType==='date'){var dateFormat=app.date.convertFormat(app.user.getPreference('datepref'));if(dateFormat){if(app.date(newValue,[dateFormat],true).isValid()){return newValue;}}else{if(app.date(newValue).isValid()){return newValue;}}}else{return newValue;}}}
return false;},_fieldVerifyCurrencyValue:function(value){value=value.toString().trim();var config=app.metadata.getConfig(),decSep=app.user.getPreference('decimal_separator')||config.defaultDecimalSeparator||'.',groupSep=app.user.getPreference('number_grouping_separator')||config.defaultNumberGroupingSeparator||',',currency=app.user.getPreference('currency_id')||app.currency.getBaseCurrencyId(),currency_symbol=app.currency.getCurrencySymbol(currency),regex=new RegExp('^('+this._fieldEscapeRegexChar(currency_symbol)+')?(([\\d]{1,3}(?:'
+this._fieldEscapeRegexChar(groupSep)+'?[\\d]{3})*)?((?:'
+this._fieldEscapeRegexChar(decSep)+'[\\d]+)))'),parts=value.match(regex),isValid=true;if(value.length===0||_.isNull(parts)||_.isEmpty(parts[0])||parts[0]!=value){isValid=false;}
return isValid;},_fieldEscapeRegexChar:function(character){var needs_escape=['.','\\','+','*','?','[','^',']','$','(',')','{','}','=','!','<','>','|',':','-'];if(_.indexOf(needs_escape,character)!=-1){character='\\'+character;}
return character;},_fieldVerifyIntValue:function(value){var regex=new RegExp('^\\d+$'),match=value.toString().match(regex);if(_.isNull(match)){return false;}
var defValidation=this.def.validation,isValid=true;if(defValidation&&defValidation.type==='range'&&!_.isUndefined(defValidation.min)&&!_.isUndefined(defValidation.max)&&(value<defValidation.min||value>defValidation.max)){isValid=false;}
return isValid;},_fieldParsePercentage:function(value,decimals){var orig=this.model.get(this.name),config=app.metadata.getConfig(),decSep=app.user.getPreference('decimal_separator')||config.defaultDecimalSeparator||'.',groupSep=app.user.getPreference('number_grouping_separator')||config.defaultNumberGroupingSeparator||',',regex=new RegExp('^([+-])(([\\d]{1,3}(?:'+this._fieldEscapeRegexChar(groupSep)
+'[\\d]{3})*|(?:[\\d]))*((?:'+this._fieldEscapeRegexChar(decSep)+'[\\d]+))?)(\\%)?'),parts=value.toString().match(regex),isPercent=(parts&&parts[5]==='%'),isAddition=(parts&&parts[1]==='+'),isSubtraction=(parts&&parts[1]==='-'),amount;if(parts&&parts[0]===value&&parts[2]!='0'){amount=this.unformat(parts[2]);if(isPercent){value=app.math.mul(app.math.div(amount,100),orig);}else{value=amount;}
if(isAddition){value=app.math.add(orig,value);}else{if(isSubtraction){value=app.math.sub(orig,value);}}
value=app.math.round(value,decimals);}
return this.format(value.toString());},handleHideDatePicker:function(){var $field=this.$(this.fieldTag),value=$field.val();if(this.isHiding){this.isHiding=false;return true;}
this.isHiding=true;if(_.isEmpty(value)){$field.val(this.format());return;}
value=this.unformat(value);if(!_.isEmpty(value)){this.model.set(this.name,value);this.setMode('list');return;}},bindDomChange:function(){if(this.isView){return this._super('bindDomChange');}
if(!(this.model instanceof Backbone.Model)){return;}
this._fieldBindDomChange();},clearErrorDecoration:function(){this._fieldIsErrorState=false;var ctx=this.context.parent||this.context;ctx.trigger('field:error',this,false);this._fieldErrorMessage='';},setMode:function(name){if(name==='list'){this.$(this.fieldTag).off('keydown.record'+this.cid);$(document).off('mousedown.record'+this.cid);if(this.type==='date'){$('.main-pane, .flex-list-view-content').off('scroll.'+this.cid);}}
if(this._fieldIsErrorState){this.clearErrorDecoration();}
app.view.Field.prototype.setMode.call(this,name);this._fieldIsInEdit=(this.action==='edit');if(this._fieldIsInEdit){this.context.trigger('field:editable:open',this.cid);}else{this.$el.removeClass('error');}
if(this.action!=='edit'&&this.type==='date'){this.$el.closest('td').removeClass('td-inline-edit');}},_highlightChanges:function(){let tableCell=this.$el.closest('td');if(this.action==='edit'){tableCell.removeClass('changed-value-highlight');}else{tableCell.toggleClass('changed-value-highlight',this._hasModelValueChanged());}},_hasModelValueChanged:function(){let currentValue=this.model.get(this.name);let syncedValue=this.model.getSynced()[this.name];if(this.type==='currency'){let diff=Math.abs(this.unformat(currentValue)-this.unformat(syncedValue));return Math.round(diff*100)!==0;}else if(this.type==='date'){return currentValue!==syncedValue;}else{return!_.isEqual(this.unformat(currentValue),this.unformat(syncedValue));}}});});})(SUGAR.App);