(function(app){app.events.on('app:init',function(){app.plugins.register('DragdropSelect2',['field'],{selectedClass:'drag-drop-selected',itemSelector:'li.select2-search-choice',clickEventName:'click.selectable',multiSelectNone:'none',multiSelectItem:'item',multiSelectRange:'range',onAttach:function(){this.on('init',function(){this.view.on('dragDropSelect2:selected',_.bind(this._handleItemSelected,this));app.shortcuts.register({id:'DragdropSelect2:SelectAll',keys:'ctrl+a',component:this,description:'LBL_SHORTCUT_DRAGDROPSELECT2_SELECTALL',callOnFocus:true,handler:function(){this.context.trigger('dragdropselect2:select:all',event);}});this.context.on('dragdropselect2:select:all',function(event){if($.contains(this.el,event.target)||!_.isEmpty(this.$lastSelectedItem)){this._selectAll();this.$selectablSelect2.select2('close');}},this);});},_isDroppableElement:function($element){return $element.length>0&&!_.isUndefined($element.droppable('instance'));},_isDraggableElement:function($element){return $element.length>0&&!_.isUndefined($element.draggable('instance'));},setDragDropPluginEvents:function($select2){var $items=this.$(this.itemSelector);this.setSelectable($select2,$items);this.setDraggable($select2,$items);this.setDroppable($select2);},setSelectable:function($select2,$items){var self=this;this.$selectablSelect2=$select2;if(this.$selectableItems){this.$selectableItems.off(this.clickEventName);}
this.$selectableItems=$items;this.$selectableItems.on(this.clickEventName,function(event){self.markSelected($(this),self._getMultiSelectType(event));event.stopPropagation();});if(!this.$clearOnClickDoc){this.$clearOnClickDoc=$(document);this.$clearOnClickDoc.on(this.clickEventName,_.bind(this._clearSelected,this));}
if(this.$clearOnContainerClick){this.$clearOnContainerClick.off(this.clickEventName);}
this.$clearOnContainerClick=$select2.select2('container');this.$clearOnContainerClick.off(this.clickEventName);this.$clearOnContainerClick.on(this.clickEventName,_.bind(this._clearSelected,this));},markSelected:function($item,multiSelectType){var rangeTraversal,$rangeItems;if(multiSelectType===this.multiSelectRange&&!_.isEmpty(this.$lastSelectedItem)&&!$item.is(this.$lastSelectedItem)){rangeTraversal=($item.index()>=this.$lastSelectedItem.index())?'nextUntil':'prevUntil';$rangeItems=this.$lastSelectedItem[rangeTraversal]($item);$rangeItems.addClass(this.selectedClass);$item.addClass(this.selectedClass);}else if(multiSelectType===this.multiSelectItem){$item.toggleClass(this.selectedClass);}else{this._clearSelected();$item.addClass(this.selectedClass);}
this.$lastSelectedItem=($item.hasClass(this.selectedClass))?$item:null;this.view.trigger('dragDropSelect2:selected',this.name);},setDraggable:function($select2,$items){var self=this,$mainPane=this.$el.closest('.main-pane'),selectedClassSelector='.'+self.selectedClass;if(this.$draggableItems&&this._isDraggableElement(this.$draggableItems)){this.$draggableItems.draggable('destroy');}
this.$draggableItems=$items;this.$draggableItems.draggable({containment:$mainPane,distance:10,helper:function(event){var $helper=$('<div class="drag-drop-select2-helper"></div>'),$clickedItem=$(event.target).closest('li');$helper.data('sourceField',self.name);$helper.appendTo($mainPane);if(!$clickedItem.hasClass(self.selectedClass)){self._clearSelected();$clickedItem.addClass(self.selectedClass);}
self.$(selectedClassSelector).each(function(){$(this).find('[data-id]').clone().removeAttr('rel').appendTo($helper);});return $helper.get(0);},start:function(){self.$(selectedClassSelector).hide();},stop:function(){self.$(selectedClassSelector).show();}});},setDroppable:function($select2){var self=this,$select2Container=$select2.select2('container');if(this.$select2Container===$select2Container){return;}
if(this.$select2Container&&this._isDroppableElement(this.$select2Container)){this.$select2Container.droppable('destroy');}
this.$select2Container=$select2Container;this.$select2Container.droppable({activeClass:'drop-highlight',hoverClass:'drop-hover',drop:function(event,ui){var sourceField=$(ui.helper).data('sourceField');var sourceCollection=self.model.get(sourceField);var targetCollection=self.model.get(self.name);var draggedItems=[];var droppedItems;if(sourceField===self.name){return;}
$(ui.helper).find('[data-id]').each(function(){var item=sourceCollection.get($(this).data('id'));if(item){draggedItems.push(item);}});droppedItems=_.map(draggedItems,function(model){return model.clone();});if(_.isFunction(self.dropDraggedItems)){self.dropDraggedItems(sourceCollection,targetCollection,draggedItems,droppedItems);}else{sourceCollection.remove(draggedItems);targetCollection.add(droppedItems);}}});},_getMultiSelectType:function(event){if(event.shiftKey===true){return this.multiSelectRange;}else if(event.metaKey===true||event.ctrlKey===true){return this.multiSelectItem;}else{return this.multiSelectNone;}},_clearSelected:function(){this.$(this.itemSelector).removeClass(this.selectedClass);this.$lastSelectedItem=null;},_selectAll:function(){this.$(this.itemSelector).addClass(this.selectedClass);this.view.trigger('dragDropSelect2:selected',this.name);},_handleItemSelected:function(fieldName){if(fieldName!==this.name){this._clearSelected();}},onDetach:function(){if(this.$selectableItems){this.$selectableItems.off(this.clickEventName);}
if(this.$clearOnClickDoc){this.$clearOnClickDoc.off(this.clickEventName);}
if(this.$clearOnContainerClick){this.$clearOnContainerClick.off(this.clickEventName);}
if(this.$draggableItems&&this._isDraggableElement(this.$draggableItems)){this.$draggableItems.draggable('destroy');}
if(this.$select2Container&&this._isDroppableElement(this.$select2Container)){this.$select2Container.droppable('destroy');}}});});})(SUGAR.App);