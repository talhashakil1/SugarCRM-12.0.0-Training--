(function(app){app.events.on('app:init',function(){app.plugins.register('Editable',['view'],{onAttach:function(component,plugin){this.editableKeyDowned=_.bind(function(evt){this.editableHandleKeyDown.call(this,evt,evt.data.field);},this);this.editableMouseClicked=_.bind(function(evt){this.editableHandleMouseDown.call(this,evt,evt.data.field);},this);this.on('init',function(){app.routing.before('route',this.beforeRouteChange,this);$(window).on('beforeunload.'+this.cid,_.bind(this.warnUnsavedChangesOnRefresh,this));this.before('unsavedchange',this.beforeViewChange,this);if(app.sideDrawer&&app.sideDrawer.before){app.sideDrawer.before('side-drawer:close side-drawer:content-changed',this.beforeContainerChange,this);}
var omniDashboard=this.closestComponent('omnichannel-dashboard');if(omniDashboard){omniDashboard.before('omni-dashboard:close omni-dashboard:content-changed',this.beforeContainerChange,this);}
if(_.isEmpty(app.additionalComponents['drawer'])){return;}
app.events.on('editable:beforehandlers:off',this.unbindBeforeHandler,this);this._currentUrl=Backbone.history.getFragment();});},beforeRouteChange:function(params){if(this.closestComponent('omnichannel-dashboard')){return true;}
var onConfirm=_.bind(this.onConfirmRoute,this);return this.warnUnsavedChanges(onConfirm);},beforeViewChange:function(param){if(!(param&&_.isFunction(param.callback))){app.logger.error('Custom unsavedchange must contain callback function.');return true;}
var onConfirm=_.bind(function(){app.events.trigger('editable:beforehandlers:off');if(param.callback&&_.isFunction(param.callback)){param.callback.call(this);}},this);return this.warnUnsavedChanges(onConfirm,param.message);},beforeContainerChange:function(params){var callback=params.callback;var message=params.message||'LBL_ONE_OR_MORE_UNSAVED_CHANGES';return this.beforeViewChange({callback:callback,message:message});},warnUnsavedChanges:function(onConfirm,customMessage,onCancel){if(this.resavingAfterMetadataSync){return false;}
if(this.disposed){return true;}
this.$(':focus').trigger('change');if(_.isFunction(this.hasUnsavedChanges)&&this.hasUnsavedChanges()){this._targetUrl=Backbone.history.getFragment();app.router.navigate(this._currentUrl,{trigger:false,replace:true});app.alert.show('leave_confirmation',{level:'confirmation',messages:app.lang.get(customMessage||'LBL_WARN_UNSAVED_CHANGES',this.module),onConfirm:onConfirm,onCancel:onCancel||$.noop});return false;}
return true;},warnUnsavedChangesOnRefresh:function(){if(this.resavingAfterMetadataSync){return false;}
if(_.isFunction(this.hasUnsavedChanges)&&this.hasUnsavedChanges()){return app.lang.get('LBL_WARN_UNSAVED_CHANGES',this.module);}},onConfirmRoute:function(){app.events.trigger('editable:beforehandlers:off');if(this._currentUrl===this._targetUrl){app.router.refresh();}else{app.router.navigate(this._targetUrl,{trigger:true});}},toggleFields:function(fields,isEdit,callback){if(!_.isArray(fields)){return;}
var viewName=!!isEdit?'edit':this._getViewAction();var numOfToggledFields=fields.length;var view=this;_.each(fields,function(field){if(field.disposed){return;}
if(field.action===viewName){field.$el.closest('.record-cell').toggleClass('edit',(viewName==='edit'));numOfToggledFields--;return;}
var meta=field.def;var viewDefs=field.viewDefs||{};if(meta&&viewDefs&&isEdit&&app.utils.isFieldAlwaysReadOnly(meta,viewDefs)){numOfToggledFields--;return;}
_.defer(function(field){if(field.disposed!==true){field.setMode(viewName);field.$el.closest('.record-cell').toggleClass('edit',(viewName==='edit'));numOfToggledFields--;if(numOfToggledFields===0){if(_.isFunction(callback)){callback();}
view.trigger('editable:toggle_fields',fields,viewName);}}},field);this.turnOffFieldEvents(field);},this);},turnOffFieldEvents:function(field){if(_.isFunction(field.unbindKeyDown)){field.unbindKeyDown(this.editableKeyDowned);}else{field.$(field.fieldTag).off('keydown.record',this.editableKeyDowned);}
$(document).off('mousedown.record'+field.name,this.editableMouseClicked);},turnOffEvents:function(fields){_.each(fields,function(field){this.turnOffFieldEvents(field);},this);},toggleField:function(field,isEdit,noFocus){var viewName;if(_.isUndefined(isEdit)){if(_.contains([this.action,this.viewAction,'erased'],field.tplName)){viewName='edit';}else{viewName=this._getViewAction();}}else{viewName=!!isEdit?'edit':this._getViewAction();}
if(!field.triggerBefore('toggleField',viewName)){return false;}
if(field.hasChanged()&&viewName==='detail'){return;}
field.setMode(viewName);if(viewName==='edit'&&!noFocus){if(_.isFunction(field.focus)){field.focus();}else{var $el=field.$(field.fieldTag+':first');$el.focus().val($el.val());}
if(_.isFunction(field.bindKeyDown)){field.bindKeyDown(this.editableKeyDowned);}else{field.$(field.fieldTag).on('keydown.record',{field:field},this.editableKeyDowned);}
if(_.isFunction(field.bindDocumentMouseDown)){field.bindDocumentMouseDown(this.editableMouseClicked);}else{$(document).on('mousedown.record'+field.name,{field:field},this.editableMouseClicked);}
field.$el.closest('.record-cell').toggleClass('edit',true);}else{if(_.isFunction(field.unbindKeyDown)){field.unbindKeyDown();}else{field.$(field.fieldTag).off('keydown.record');}
$(document).off('mousedown.record'+field.name);field.$el.closest('.record-cell').toggleClass('edit',false);}
field.trigger('editable:toggle-field',viewName);},nextField:function(field,direction){if(!field){return;}
field.$(field.fieldTag).trigger('change');direction=_.contains(['nextField','prevField'],direction)?direction:'nextField';var nextField=field[direction];if(!nextField){return;}
if(_.isFunction(this.toggleMoreLess)&&nextField.$el.closest('.panel_hidden').hasClass('hide')){this.toggleMoreLess('more');}
this.toggleField(field,false);while(nextField.isDisabled()){if(nextField[direction]){nextField=nextField[direction];}else{break;}}
if(!nextField.isDisabled()){this.toggleField(nextField,true);}},getEditableFields:function(fields,noEditFields){var editableFields=[];_.each(fields,function(field){var readonlyField=this._isReadOnly(field,noEditFields);if(!readonlyField){editableFields.push(field);}},this);this._formDoublyLinkedList(editableFields);return editableFields;},_formDoublyLinkedList:function(fields){if(fields.length<=1){return;}
var firstField;var previousField;_.each(fields,function(field){if(previousField){previousField.nextField=field;field.prevField=previousField;}else{firstField=field;}
previousField=field;});if(previousField){previousField.nextField=firstField;firstField.prevField=previousField;}},_isReadOnly:function(field,noEditFields){var isLocked=_.contains(this.model.get('locked_fields'),field.def.name);if((app.utils.isFieldAlwaysReadOnly(field.def,field.viewDefs))||(field.def.type!=='fieldset'&&isLocked)||_.indexOf(noEditFields,field.name)>=0){return true;}
return false;},_getViewAction:function(){return!_.isEmpty(this.viewAction)?this.viewAction:this.action;},editableHandleMouseDown:function(evt,field){if(field.tplName===this._getViewAction()){return;}
var currFieldParent=field.$el,targetPlaceHolder=this.$(evt.target).parents("span[sfuuid='"+field.sfId+"']"),preventPlaceholder=this.$(evt.target).closest('.prevent-mousedown');if(!currFieldParent){return;}
var inPreventPlaceholder=(preventPlaceholder.length>0);var inTargetPlaceholder=(targetPlaceHolder.length>0);var isFocusInField=(currFieldParent.find(':focus').length>0);var drawerOpened=!_.isEmpty(app.drawer._components);if(inPreventPlaceholder||inTargetPlaceholder||isFocusInField||drawerOpened){return;}
this.toggleField(field,false);this.trigger('editable:mousedown',evt,field);},editableHandleKeyDown:function(evt,field){if(evt.which==27){this.toggleField(field,false);}
this.trigger('editable:keydown',evt,field);},unbindBeforeHandler:function(){app.routing.offBefore('route',this.beforeRouteChange,this);$(window).off('beforeunload.'+this.cid);if(app.sideDrawer&&app.sideDrawer.offBefore){app.sideDrawer.offBefore('side-drawer:close side-drawer:content-changed',this.beforeContainerChange,this);}
var omniDashboard=this.closestComponent('omnichannel-dashboard');if(omniDashboard){omniDashboard.offBefore('omni-dashboard:close omni-dashboard:content-changed',this.beforeContainerChange,this);}
if(_.isEmpty(app.additionalComponents['drawer'])){return;}
app.drawer.offBefore('reset',this.beforeRouteChange,this);this.offBefore('unsavedchange');},onDetach:function(){$(document).off('mousedown',this.editableMouseClicked);this.editableKeyDowned=null;this.editableMouseClicked=null;app.events.off('editable:beforehandlers:off',null,this);this.unbindBeforeHandler();}});});})(SUGAR.App);