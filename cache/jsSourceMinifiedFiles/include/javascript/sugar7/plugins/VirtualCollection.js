(function(app){app.events.on('app:init',function(){var BeanOverrides,Link,VirtualCollection;Link=app.BeanCollection.extend({initialize:function(models,options){options||(options={});if(options.module){this.module=options.module;delete options.module;}
this.synced=[];this.defaults=[];app.BeanCollection.prototype.initialize.call(this,models,options);},isSynced:function(model){return _.contains(this.synced,model.id);},transpose:function(){var actions;actions=this.reduce(function(json,model){switch(model.get('_action')){case'delete':json.delete.push(model.id);break;case'create':json.create.push(_.omit(model.toJSON(),'_action'));break;default:json.add.push(_.omit(model.toJSON(),'_action'));}
return json;},{create:[],add:[],delete:[]});if(actions.create.length===0){delete actions.create;}
if(actions.add.length===0){delete actions.add;}
if(actions.delete.length===0){delete actions.delete;}
return actions;},linkRecord:function(model){model.set('_action',model.isNew()?'create':'add');this.add(model,{merge:true});return this;},unlinkRecord:function(model){if(this.isSynced(model)){model.set('_action','delete');this.add(model,{merge:true});}else{this.undo(model);}
return this;},undo:function(model){this.removeDefault(model);this.remove(model);return this;},appendDefault:function(model){this.defaults.push(model.id);return this;},removeDefault:function(model){this.defaults=_.without(this.defaults,model.id);return this;},hasChanged:function(){return _.difference(_.pluck(this.models,'id'),this.defaults).length>0;},setSynced:function(models){var undos=[];this.synced=_.isArray(models)?models.slice():this.pluck('id');this.each(function(model){if(_.contains(this.synced,model.id)){undos.push(model);}},this);_.each(undos,this.undo,this);return this;},clearAndUpdateSynced:function(){var linked,unlinked;linked=_.union(this.where({'_action':'create'}),this.where({'_action':'add'}));unlinked=this.where({'_action':'delete'});this.setSynced(_.union(this.synced,_.pluck(linked,'id')));this.setSynced(_.difference(this.synced,_.pluck(unlinked,'id')));return this;},addSynced:function(model){this.synced.push(model.id);this.undo(model);return this;}},false);VirtualCollection=app.MixedBeanCollection.extend({constructor:function(models,options){app.logger.warn('VirtualCollection is deprecated since 8.3.0 and may be removed in 9.3.0 or any subsequent release.');options||(options={});app.MixedBeanCollection.prototype.constructor.call(this,models,options);this.offsets=options.offsets||{};_.each(this.links,function(link){link.setSynced();if(_.isUndefined(this.offsets[link.link.name])){this.offsets[link.link.name]=link.synced.length;}},this);},initialize:function(models,options){options||(options={});this.parent=options.parent;delete options.parent;this.fieldName=options.fieldName;delete options.fieldName;this.context=options.context;delete options.context;this.relatedModules={};this.links=_.reduce(options.links,function(memo,link){var module,options;link=(_.isString(link))?link:link.name;module=app.data.getRelatedModule(this.parent.module,link);this.relatedModules[module]=link;options={link:{name:link,bean:this.parent},module:module};memo[link]=new Link([],options);return memo;},{},this);delete options.links;this.parent.on('sync',function(){_.each(this.links,function(link){link.clearAndUpdateSynced();});},this);app.MixedBeanCollection.prototype.initialize.call(this,models,options);},_prepareModel:function(model,options){model=app.MixedBeanCollection.prototype._prepareModel.call(this,model,options);model.link=this.links[this.relatedModules[model.module]].link;return model;},add:function(models,options){var added=[];options||(options={});models=_.isArray(models)?models.slice():[models];if(_.compact(models).length===0){return this;}
_.each(models,function(model){var existingModel,relationship;model=this._prepareModel(model,options);existingModel=this.get(model.id);relationship=this.links[model.link.name];if(existingModel){if(options.merge){relationship.linkRecord(model);}}else{if(relationship.isSynced(model)){relationship.undo(model);}else{relationship.linkRecord(model);}}
if(!existingModel||options.merge){app.MixedBeanCollection.prototype.add.call(this,model,options);added.push(this.get(model.id));}
if(options.default){relationship.appendDefault(model);}},this);if(!options.silent&&added.length>0){this._triggerChange(added,options);}
return this;},remove:function(models,options){var removed=[];options||(options={});models=_.isArray(models)?models.slice():[models];if(_.compact(models).length===0){return this;}
_.each(models,function(model){var existingModel,relationship;existingModel=this.get(model);if(existingModel){relationship=this.links[existingModel.link.name];relationship.unlinkRecord(existingModel);app.MixedBeanCollection.prototype.remove.call(this,existingModel,options);removed.push(existingModel);}},this);if(!options.silent&&removed.length>0){this._triggerChange(removed,options);}
return this;},reset:function(models,options){var existingModels;options||(options={});models=_.isArray(models)?models.slice():[models];this.revert(_.extend({},options,{silent:true}));existingModels=this.models.slice();app.MixedBeanCollection.prototype.reset.call(this,models,options);_.each(existingModels,function(existingModel){var relationship=this.links[existingModel.link.name];function match(newModel){return(newModel.id===existingModel.id&&newModel.module===existingModel.module);}
relationship.undo(existingModel);if(!this.find(match)){relationship.unlinkRecord(existingModel);}},this);if(!options.silent){this._triggerChange(this.models,options);}
return this;},revert:function(options){var add,remove;options||(options={});add=[];remove=[];_.each(this.links,function(relationship){relationship.each(function(model){if(relationship.isSynced(model)){add.push(model);}else{remove.push(model);}});});this.remove(remove,{silent:true});this.add(add,{merge:true,silent:true});if(!options.silent){this._triggerChange(this.models,options);this.trigger('reset',this,options);}
return this;},hasChanged:function(){var changed=false;_.each(this.links,function(link){if(link.hasChanged()){changed=true;}},this);return changed;},hasMore:function(){return _.some(this.offsets,function(offset){return(offset>-1);});},fetch:function(options){var callbacks,complete,error,params,success,url;options||(options={});params={};params.erased_fields=true;params.fields=options.fields?options.fields:['name'];params.order_by=options.order_by||this.parent.fields[this.fieldName].order_by;if(!_.isArray(params.order_by)){params.order_by=[params.order_by];}
_.each(params.order_by,function(sort){var field=sort.split(':')[0];if(!_.contains(params.fields,field)){params.fields.push(field);}});params.module_list=_.keys(this.relatedModules).join(',');params.fields=params.fields.join(',');params.order_by=params.order_by.join(',');params.max_num=options.limit||app.config.maxSubpanelResult;if(options.offset){params.offset=options.offset;}
callbacks={};success=options.success;error=options.error;complete=options.complete;callbacks.success=_.bind(function(data,request){if(success){success(data,request);}
this.parent.trigger('sync:'+this.fieldName,this,data,options,request);},this);if(error){callbacks.error=error;}
if(complete){callbacks.complete=complete;}
url=[app.api.serverUrl,this.parent.module,this.parent.id,'collection',this.fieldName].join('/');_.each(params,function(value,key){if(value===null||value===undefined){delete params[key];}});params=$.param(params);if(params.length>0){url+='?'+params;}
return app.api.call('read',url,null,callbacks);},fetchAll:function(options){var self;var success;var complete;function paginate(){if(self.hasMore()){self.paginate(options);}else{if(success){success(self,options);}
if(complete){complete(self,options);}}}
self=this;options||(options={});if(options.success){success=options.success;delete options.success;}
if(options.complete){complete=options.complete;delete options.complete;}
options.success=paginate;options.limit=_.max([options.limit,app.config.maxSubpanelResult,app.config.maxQueryResult]);paginate();},paginate:function(options){var success;options||(options={});options.offset=this.offsets;success=options.success;options.success=_.bind(function(data,request){var offsets,records;data||(data={});records=data.records||[];offsets=data.next_offset||{};_.each(offsets,function(offset,link){this.offsets[link]=offset;},this);this.add(records,{merge:true});_.each(records,function(record){var model;model=this._prepareModel(record);this.links[model.link.name].addSynced(model);},this);if(success){success(data,request);}},this);this.fetch(options);},search:function(options){var callbacks,params,url;params={};options||(options={});params.q=options.query;params.max_num=options.limit;params.search_fields=options.search_fields?options.search_fields.join(','):'name';params.fields=options.fields?options.fields.join(','):'name';params.erased_fields=true;if(this.links){params.module_list=_.map(this.links,function(link){return link.module;}).join(',');}
callbacks={};callbacks.success=function(data,request){if(options.success){options.success(app.data.createMixedBeanCollection(data.records),request);}};if(options.error){callbacks.error=options.error;}
if(options.complete){callbacks.complete=options.complete;}
url=app.api.buildURL('Calendar','invitee_search',null,params);return app.api.call('read',url,null,callbacks);},_triggerChange:function(change,options){this.parent.trigger('change:'+this.fieldName,this.parent,this,change,options);this.parent.trigger('change',this.parent,options);}});BeanOverrides=function(model){this.model=model;};BeanOverrides.prototype.toJSON=function(collections,links,options){var json={},fields=_.unique(_.union(collections,_.keys(links)));_.each(fields,function(attribute){var field=this.get(attribute);if(!field){return;}
if(_.contains(collections,attribute)){json[attribute]=field.toJSON(options);}
_.each(links[attribute],function(link){var actions=field.links[link].transpose();if(actions.create||actions.add||actions.delete){json[link]=actions;}});},this.model);return json;};BeanOverrides.prototype.copy=function(source,fields,options){var attrs,clone,vardefs;attrs={};vardefs=app.metadata.getModule(this.model.module).fields;clone=function(model){var attributes=_.chain(model.attributes).clone().omit('_action').value();return app.data.createBean(model.module,attributes);};_.each(fields,function(name){attrs[name]=[];});if(_.size(attrs)>0){this.model.set(attrs,options);}
_.each(fields,function(name){var def=vardefs[name],collection;if(def&&def.duplicate_on_record_copy!=='no'&&(def.duplicate_on_record_copy==='always'||!def.auto_increment)&&source.has(name)){collection=this.get(name);collection.add(source.get(name).map(clone));}},this.model);};BeanOverrides.prototype.set=function(attr,options){var isEqual=function(previous,current){var previousFiltered,currentFiltered,filter=function(collection){return _.map(collection.toJSON(),function(model){var result={};_.each(model,function(value,key){if(key.indexOf('_')!==0){result[key]=value;}});return result;});};if(previous){previousFiltered=filter(previous);}
if(current){currentFiltered=filter(current);}
return _.isEqual(previousFiltered,currentFiltered);};if(!this.model._changing){this.model.changed={};}
_.each(attr,function(models,key){var collection,previous;options=_.extend({},options,{parent:this,fieldName:key,links:this.fields[key].links});if(!_.isArray(models)){if(models instanceof Backbone.Collection){models=models.models;}else if(models){if(models.next_offset){options.offsets=models.next_offset;}
if(models.records){models=models.records;}else{models=[models];}}else{models=[];}}
collection=new VirtualCollection(models,options);previous=this.get(key);this.attributes[key]=collection;this.setDefault(key,collection);if(!isEqual(previous,this.get(key))){this.changed[key]=collection;if(!options.silent){this.trigger('change:'+key,collection);}}},this.model);return this.model;};BeanOverrides.prototype.hasChanged=function(attr){if(attr===null||attr==='invitees'){attr=['invitees'];}else{attr=[];}
return _.some(attr,function(attribute){var collection=this.get(attribute);return(collection&&collection.hasChanged());},this.model);};BeanOverrides.prototype.changedAttributes=function(diff){var changed={};var attr='invitees';var collection=this.model.get(attr);if(collection&&collection.hasChanged()){changed[attr]=collection;}
return changed;};BeanOverrides.prototype.revertAttributes=function(options){var collection=this.model.get('invitees');if(collection){collection.revert(options);}};BeanOverrides.prototype.getSynced=function(key){var syncedAttributes={};if(key){return this.model.get(key);}
var attr='invitees';var collection=this.model.get(attr);if(collection){syncedAttributes[attr]=collection;}
return syncedAttributes;};app.plugins.register('VirtualCollection',['model'],{onAttach:function(model,plugin){var overrides=new BeanOverrides(this);this.toJSON=_.wrap(this.toJSON,function(_super,options){var attrs,fields,collectionFieldNames,collections,links,nonAttrFields,collectionsToJSON,attrToJSON;fields=(options&&options.fields)?options.fields:_.keys(this.attributes);collectionFieldNames=this.getCollectionFieldNames();collections=_.intersection(collectionFieldNames,fields);links={};nonAttrFields=_.clone(collections);_.each(collectionFieldNames,function(fieldName){var field=this.get(fieldName);if(_.isObject(field)&&field.links){_.each(field.links,function(link){if(_.contains(fields,link.link.name)){(links[fieldName]||(links[fieldName]=[])).push(link.link.name);nonAttrFields.push(link.link.name);}});}},this);attrs=_.difference(fields,_.unique(nonAttrFields));collectionsToJSON=overrides.toJSON(collections,links,options);attrToJSON=_super.call(this,_.extend({},options,{fields:attrs}));return _.extend(attrToJSON,collectionsToJSON);});this.copy=_.wrap(this.copy,function(_super,source,fields,options){var attrs,collections,collectionFieldNames,vardefs;vardefs=app.metadata.getModule(this.module).fields;fields=fields||_.pluck(vardefs,'name');collectionFieldNames=this.getCollectionFieldNames();collections=_.intersection(collectionFieldNames,fields);attrs=_.difference(fields,collectionFieldNames);overrides.copy(source,collections,options);_super.call(this,source,attrs,options);});this.set=_.wrap(this.set,function(_super,key,val,options){var attrs,collections,hasChanged,changedAttributes;if(key==null){return this;}
if(typeof key==='object'){attrs=key;options=val;}else{(attrs={})[key]=val;}
options||(options={});collections=_.pick(attrs,this.getCollectionFieldNames());attrs=_.omit(attrs,_.keys(collections));overrides.set(collections,options);changedAttributes=this.changed;_super.call(this,attrs,options);hasChanged=this.hasChanged();_.extend(this.changed,changedAttributes);if(!options.silent&&!hasChanged&&!_.isEmpty(changedAttributes)){this.trigger('change',this,options);}
return this;});this.get=_.wrap(this.get,function(_super,attr){if(attr==='invitees'){return Backbone.Model.prototype.get.call(this,attr);}
return _super.call(this,attr);});this.hasChanged=_.wrap(this.hasChanged,function(_super,attr){return _super.call(this,attr)||overrides.hasChanged(attr);});this.changedAttributes=_.wrap(this.changedAttributes,function(_super,diff){var fromOverrides=overrides.changedAttributes();var nonCollectionFields;var changed;if(diff){fromOverrides=_.pick(fromOverrides,_.keys(diff));}
nonCollectionFields=_super.call(this,diff)||{};changed=_.extend(nonCollectionFields,fromOverrides);return _.isEmpty(changed)?false:changed;});this.revertAttributes=_.wrap(this.revertAttributes,function(_super,options){overrides.revertAttributes(options);_super.call(this,options);});this.getSynced=_.wrap(this.getSynced,function(_super,key){var fromOverrides=overrides.getSynced(key);var fromSuper=_super.call(this,key);if(key){return _.contains(this.getCollectionFieldNames(),key)?fromOverrides:fromSuper;}
return _.extend(app.utils.deepCopy(fromSuper||{}),fromOverrides);});},getCollectionFieldNames:function(){if(this.fields.invitees){return['invitees'];}
return[];}});});})(SUGAR.App);