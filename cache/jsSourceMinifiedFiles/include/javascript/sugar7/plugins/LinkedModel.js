(function(app){app.events.on('app:init',function(){app.plugins.register('LinkedModel',['view','field'],{createLinkModel:function(parentModel,link){if(this.context&&this.context.parent&&this.context.parent.isCreate()){return app.data.createBean(app.data.getRelatedModule(parentModel.module,link));}
var model=app.data.createRelatedBean(parentModel,null,link),relatedFields=app.data.getRelateFields(parentModel.module,link),parentModule=app.metadata.getModule(parentModel.module);if(parentModule&&parentModule.fields[link]&&parentModule.fields[link].populate_list){model.relatedAttributes=model.relatedAttributes||{};this._parsePopulateList(parentModule.fields[link].populate_list,parentModel,model);}
if(!_.isEmpty(relatedFields)){model.relatedAttributes=model.relatedAttributes||{};_.each(relatedFields,function(field){var attrs={};var parentValue=parentModel.get(field.rname);if(!parentValue&&parentModel.fields[field.rname]&&parentModel.fields[field.rname].type=='fullname'){parentValue=parentModel.get('full_name')||app.utils.formatNameLocale(parentModel.attributes);}
attrs[field.name]=parentValue;attrs[field.id_name]=parentModel.get('id');if(field.link){attrs[field.link]=parentModel.toJSON();}
model.set(attrs);model.relatedAttributes[field.name]=parentModel.get(field.rname);model.relatedAttributes[field.id_name]=parentModel.get('id');if(field.populate_list){this._parsePopulateList(field.populate_list,parentModel,model);}},this);}
this.populateParentFields(model,parentModel);return model;},_parsePopulateList:function(populate_list,parentModel,model){_.each(populate_list,function(target,source){source=_.isNumber(source)?target:source;if(!_.isUndefined(parentModel.get(source))&&app.acl.hasAccessToModel('edit',model,target)){model.set(target,parentModel.get(source));model.relatedAttributes[target]=parentModel.get(source);}},this);},createRelatedRecord:function(module,link){var bwcExceptions=['Emails'],moduleMeta=app.metadata.getModule(module);if(moduleMeta&&moduleMeta.isBwcEnabled&&!_.contains(bwcExceptions,module)){this.routeToBwcCreate(module);}else{this.openCreateDrawer(module,link);}},routeToBwcCreate:function(module){var proto=Object.getPrototypeOf(this);if(_.isFunction(proto.routeToBwcCreate)){return proto.routeToBwcCreate.call(this,module);}
var parentModel=this.context.parent.get('model'),link=this.context.get('link');app.bwc.createRelatedRecord(module,parentModel,link);},openCreateDrawer:function(module,link){var proto=Object.getPrototypeOf(this);if(_.isFunction(proto.openCreateDrawer)){return proto.openCreateDrawer.call(this,module,link);}
link=link||this.context.get('link');var context=(this.context.get('name')==='tabbed-dashlet')?this.context:(this.context.parent||this.context);var parentModel=context.get('model')||context.parent.get('model'),model=this.createLinkModel(parentModel,link),self=this;app.drawer.open({layout:'create',context:{create:true,module:model.module,model:model}},function(context,model){if(!model){return;}
let slCtx=self.closestComponent('main-pane').getComponent('record')._slCtx;if(slCtx){slCtx.updateRelatedCollectionValues(parentModel,link,null,null,model,'add');}
self.trigger('linked-model:create',model);});},populateParentFields:function(model,parentModel){var parentModule=parentModel.module||parentModel.get("module")||parentModel.get("_module");_.each(model.fields,function(def){if(def.type&&def.type==='parent'){if(app.lang.getAppListStrings(def.options)[parentModule]){var attributes={};attributes[def.type_name]=parentModule;if(parentModel.get('id')){attributes[def.id_name]=parentModel.get('id');attributes[def.name]=app.utils.getRecordName(parentModel);attributes.parent=parentModel.toJSON();}
model.set(attributes);}}});if(parentModule=="Contacts"&&parentModel.get("account_id")&&model.get("contact_id")){model.set({parent_type:"Accounts",parent_id:parentModel.get("account_id"),parent_name:parentModel.get('account_name')});}}});});})(SUGAR.App);