(function(app){app.events.on("app:init",function(){app.plugins.register('MassQuote',['view'],{blacklistRLIFields:['_acl','_module','id','quote_id'],onAttach:function(component,plugin){this.once('init',function(){this.layout.on('list:massquote:fire',this.massQuote,this);},this);},massQuote:function(){var qliModels=[];var rliObj;var loadViewObj;var parentModel;if(_.isFunction(this.hideAll)){this.hideAll();}
var massQuote=this.context.get('mass_collection');var errors={'LBL_CONVERT_INVALID_RLI_PRODUCT_PLURAL':[]};var messageTpl;var invalidItems=massQuote.filter(function(model){if(_.isEmpty(model.get('product_template_id'))&&!_.isEmpty(model.get('category_id'))){errors['LBL_CONVERT_INVALID_RLI_PRODUCT_PLURAL'].push(model);return true;}
return false;},this);if(!_.isEmpty(invalidItems)){messageTpl=app.template.getView('massupdate.invalid_link',this.module);_.each(errors,function(val,key){if(val.length!=0){var messages=[];messages.push(app.lang.get(key,this.module)+'<br>');_.each(val,function(item){messages.push(messageTpl(item.attributes));});app.alert.show(('invalid_items_'+key),{level:'error',title:app.lang.get('LBL_ALERT_TITLE_ERROR',this.module)+':',messages:messages,onLinkClick:function(){app.alert.dismiss('invalid_items_'+key);}});}},this);return;}
if(massQuote){_.each(massQuote.models,function(rliModel){rliObj=rliModel.toJSON();rliObj.revenuelineitem_id=rliObj.id;rliObj.parent_rli_id=rliObj.id;_.each(this.blacklistRLIFields,function(fieldName){delete rliObj[fieldName];},this);if(_.isEmpty(rliObj.product_template_name)){rliObj.product_template_name=rliObj.name;}else{rliObj.name=rliObj.product_template_name;}
if(_.isEmpty(rliObj.discount_price)){rliObj.discount_price=rliObj.likely_case;}
qliModels.push(app.data.createBean('Products',rliObj));},this);loadViewObj={module:'Quotes',layout:'create',action:'edit',convert:true,create:true,relatedRecords:qliModels,fromSubpanel:massQuote.fromSubpanel||false,subpanelLink:massQuote.link};parentModel=this.context.parent?this.context.parent.get('model'):this.context.get('model');loadViewObj.parentModel=parentModel;loadViewObj.fromLink=this.context.get('link');app.controller.loadView(loadViewObj);app.router.navigate('#Quotes/create',{trigger:false});}}});});})(SUGAR.App);