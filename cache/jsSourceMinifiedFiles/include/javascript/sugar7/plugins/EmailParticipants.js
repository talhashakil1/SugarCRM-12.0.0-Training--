(function(app){app.events.on('app:init',function(){function getValidationTaskName(component){return'email_participants_validator_'+component.cid;}
app.plugins.register('EmailParticipants',['field'],{onAttach:function(component,plugin){var search=_.debounce(function(query){var data={results:[],more:false};var options={q:query.term,max_num:10,erased_fields:true};var callbacks={};var url=app.api.buildURL('Mail','recipients/find',null,options);var linkName=component.getLinkName();callbacks.success=function(result){var records=_.map(result.records,function(record){record.email_address=record.email;delete record.email;return record;});records=app.data.createMixedBeanCollection(records);data.results=records.map(function(record){var ep;var parentName=app.utils.getRecordName(record);if(linkName){ep=app.data.createBean('EmailParticipants',{_link:linkName,parent:{_acl:record.get('_acl')||{},_erased_fields:record.get('_erased_fields')||[],type:record.module,id:record.get('id'),name:parentName},parent_type:record.module,parent_id:record.get('id'),parent_name:parentName});component.prepareModel(ep);}
return ep;});};callbacks.error=function(){data.results=[];};callbacks.complete=function(){query.callback(data);};app.api.call('read',url,null,callbacks);},300);this.on('init',function(){var task=getValidationTaskName(this);this.model.addValidationTask(task,_.bind(function(fields,errors,callback){var participants=this.model.get(this.name);var hasInvalidParticipants=_.some(participants.models,function(participant){return!!participant.invalid;});if(hasInvalidParticipants){errors[this.name]=errors[this.name]||{};errors[this.name][this.type]=true;}
callback(null,fields,errors);},this));});this.unbindData=_.wrap(this.unbindData,function(_super){var task=getValidationTaskName(this);if(this.model){this.model.removeValidationTask(task);}
_super.call(this);});this.getLinkName=function(){var link=this.def.links[0];return _.has(link,'name')?link.name:link;};this.prepareModel=function(model){var hasParent=model.hasParent();var parent;if(hasParent){parent=model.getParent();}
model.nameIsErased=model.isNameErased();model.emailIsErased=model.isEmailErased();model.locked=!!this.def.readonly;if(!hasParent&&!model.get('email_address_id')){model.invalid=true;}else if(!model.has('invalid_email')&&model.get('email_address_id')&&model.get('email_address')&&!model.emailIsErased){model.invalid=!app.utils.isValidEmailAddress(model.get('email_address'));}else{model.invalid=model.emailIsErased||!!model.get('invalid_email');}
if(hasParent&&parent&&app.acl.hasAccessToModel('view',parent)){model.href='#'+app.router.buildRoute(parent.module,parent.get('id'));}
return model;};this.formatForHeader=function(model,surroundNameWithQuotes){app.logger.warn('Plugins.EmailParticipants#formatForHeader is deprecated. Use '+'Model.Datas.Base.EmailParticipantsModel#toHeaderString instead.');return model.toHeaderString({quote_name:surroundNameWithQuotes});};this.getSelect2Options=function(){var module=this.module;return{containerCss:{width:'100%'},width:'off',minimumInputLength:1,selectOnBlur:true,data:this.getFormattedValue(),initSelection:_.bind(function(element,callback){callback(this.getFormattedValue());},this),query:function(query){search(query);},id:function(choice){return _.isEmpty(choice)?null:choice.cid;},createSearchChoice:_.bind(function(term,data){var choice;var address;if(data.length===0&&app.utils.isValidEmailAddress(term)){choice=app.data.createBean('EmailParticipants',{_link:this.getLinkName(),email_address:term});address=app.data.createBean('EmailAddresses',{email_address:term});address.save({},{success:_.bind(function(model){var collection=this.model.get(this.name);choice.set({email_address_id:model.get('id'),invalid_email:model.get('invalid_email'),opt_out:model.get('opt_out')});this.prepareModel(choice);if(collection.get(choice)){this.model.trigger('change:'+this.name,this.model,collection);}},this)});return this.prepareModel(choice);}},this),formatSearching:function(){return app.lang.get('LBL_LOADING',module);},formatInputTooShort:function(term,min){return'';}};};}});});})(SUGAR.App);