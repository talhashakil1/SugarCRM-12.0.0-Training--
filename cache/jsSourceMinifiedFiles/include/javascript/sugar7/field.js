(function(app){var _useRequiredLabels={"bool":true,"radioenum":'edit'};app.events.on("app:init",function(){var _fieldProto=_.clone(app.view.Field.prototype);_.extend(app.view.Field.prototype,{hideHelp:false,exclamationMarkTemplate:Handlebars.compile(`<span class="error-tooltip add-on" data-container="body" rel="tooltip" title="{{arrayJoin this ", "}}">
                 <i class="sicon sicon-warning-circle"></i>
                 </span>`),handleValidationError:function(errors){this.clearErrorDecoration();_.defer(function(field){field._errors=errors;if(field.action==='edit'||field.view.inlineEditMode){if(field.parent){field.parent.setMode('edit');}else{field.setMode('edit');}}
if(!field._shouldRenderRequiredPlaceholder()){field.decorateRequired();}
if(field.view&&field.view.trigger){field.view.trigger('field:error',field,true);}},this);this.$el.off("keydown.record");$(document).off("mousedown.record"+this.name);},removeValidationErrors:function(){this._errors={};},_removeViewClass:function(action){this.$el.removeClass(action);},_addViewClass:function(action){this.$el.addClass(action);},showNoData:function(){var viewDefs=this.viewDefs||{};return app.utils.isFieldAlwaysReadOnly(this.def,viewDefs)&&app.acl.hasAccessToModel('readonly',this.model,this.name)&&this.name&&!this.model.has(this.name);},_isErasedField:function(){if(!this.model){return false;}
return!this.model.get(this.name)&&_.contains(this.model.get('_erased_fields'),this.name);},_hasLicenseAccess:function(){if(!this.model){return true;}
return app.acl.hasAccessToModel('license',this.model,this.name);},_checkAccessToAction:function(action){if(_.contains(this.fallbackActions,action)&&_.isUndefined(this.viewFallbackMap[action])){return true;}
if(_.result(this,'showNoData')===true){return action==='nodata';}
if(action==='erased'){return app.acl.hasAccessToModel('detail',this.model,this.name);}
return app.acl.hasAccessToModel(action,this.model,this.name);},viewFallbackMap:{'preview':'detail','list':'detail','edit':'detail','detail':'noaccess','erased':'noaccess','noaccess':'nodata'},fallbackActions:['nolicense','noaccess','nodata','erased'],_getFallbackTemplate:function(viewName){if(_.contains(this.fallbackActions,viewName)){return viewName;}
return(this.isDisabled()&&viewName==='disabled')?'edit':(this.view.fallbackFieldTemplate||'detail');},_setErasedFieldAction:function(){if(this._isErasedField()&&this.action!=='edit'){this.action='erased';this.options.viewName='erased';}},_markFieldLackingAccess:function(){if(!this._hasLicenseAccess()){this.action='nolicense';this.options.viewName='nolicense';}},_render:function(){this.clearErrorDecoration();this._processHelp();this._setErasedFieldAction();this._markFieldLackingAccess();_fieldProto._render.call(this);if(this._previousAction){this._addViewClass(this._previousAction);}
this._addViewClass(this.action);if(!_.isEmpty(this._errors)){if(this.action==='edit'){this.decorateError(this._errors);}}
if(this.def.required){this.clearRequiredLabel();if((this.action==='edit'||-1!==_.indexOf(['edit','list-edit'],this.tplName))&&this._shouldRenderRequiredPlaceholder()){this.decorateRequired();}}
if(this.def.help){this.clearHelper();if(this.action==='edit'||-1!==_.indexOf(['edit','list-edit'],this.tplName)){this.decorateHelper();}}},isFieldEmpty:function(){if(!this.model){return true;}
var value=this.model.get(this.name);return _.isNull(value)||_.isUndefined(value)||((_.isString(value)||_.isArray(value))&&_.isEmpty(value));},_processHelp:function(){if(this.meta&&!_.isUndefined(this.meta['hide_help'])){this.hideHelp=!!this.meta['hide_help'];return;}
if(this.view.action==='list'&&this.action==='edit'){this.hideHelp=true;}},clearHelper:function(){this.$el.closest('.record-cell').attr({'rel':''});},decorateHelper:function(){var title=app.lang.get(this.def.help,this.module);this.$el.closest('.record-cell').attr({'rel':'tooltip','data-title':title,'data-placement':'bottom'});},_shouldRenderRequiredPlaceholder:function(){return!this.def.no_required_placeholder;},decorateRequired:function(){var useLabels=_useRequiredLabels[this.type];useLabels=_.isString(useLabels)?(useLabels===this.tplName):useLabels;if(useLabels){this.setRequiredLabel();}else{this.setRequiredPlaceholder();}},setRequiredPlaceholder:function(el){var label=app.lang.get('LBL_REQUIRED_FIELD',this.module),placeholder;el=el||this.$(this.fieldTag).first();placeholder=el.attr('placeholder');placeholder=(placeholder)?'('+label+') '+placeholder:label;el.attr('placeholder',placeholder.trim()).addClass('required');},setRequiredLabel:function(element){var ele=element||this.$el;var $label=ele.closest('.record-cell').find(".record-label");$label.append(' <span data-required="required">('+app.lang.get("LBL_REQUIRED_FIELD",this.module)+')</span>');},clearRequiredLabel:function(element){var ele=element||this.$el;var $label=ele.closest('.record-cell').find('span[data-required]');$label.remove();},setViewName:function(view){var viewDefs=this.viewDefs||{};if(app.utils.isFieldAlwaysReadOnly(this.def,viewDefs)){var readOnlyViews=['detail','list'];view=_.contains(readOnlyViews,view)?view:'detail';}
this.options.viewName=view;},setMode:function(name){var oldAction=this._previousAction||this.action;this._removeViewClass(oldAction);_fieldProto.setMode.call(this,name);},setDisabled:function(disable,options){if(!this._checkAccessToAction('disabled')){return;}
disable=_.isUndefined(disable)?true:disable;if(disable===false&&this.isDisabled()){this._removeViewClass(this.action);}
_fieldProto.setDisabled.call(this,disable,options);var ele=$('.'+this.baseFieldName+'_should_cascade');if(ele.length===1&&!(_.isUndefined(this.def.readOnlyProp)||_.isUndefined(this.readOnlyProp))){ele.prop('disabled',(this.def.readOnlyProp||this.readOnlyProp));}},decorateError:function(errors){var ftag=this.fieldTag||'',$ftag=this.$(ftag),errorMessages=[],$tooltip;this.$el.closest('.record-cell').addClass('error');this.$el.addClass('error');if(_.isString(errors)){errorMessages.push(errors);}else{_.each(errors,function(errorContext,errorName){errorMessages.push(app.error.getErrorString(errorName,errorContext));});}
var isWrapped=$ftag.parent().hasClass('input-append');if(!isWrapped){$ftag.wrap('<div class="input-append '+ftag+'">');}
$ftag.parent().addClass('error');$tooltip=$(this.exclamationMarkTemplate(errorMessages));$ftag.after($tooltip);},_dispose:function(){_fieldProto._dispose.call(this);},clearErrorDecoration:function(){var ftag=this.fieldTag||'';var $ftag=this.$(ftag);var $parent=$ftag.parent().first();this.$('.add-on.error-tooltip').remove();var isWrappedError=$parent.hasClass('input-append')&&$parent.hasClass('error');var isWrapperException=false;_.each(['date','currency','timeselect'],function(item){isWrapperException=isWrapperException||$parent.hasClass(item);});if(isWrapperException){$parent.removeClass('error');}else if(isWrappedError){$ftag.unwrap('.input-append.error');}
this.$el.removeClass(ftag);this.$el.removeClass("error");this.$el.closest('.record-cell').removeClass("error");if(this.view&&this.view.trigger){this.view.trigger('field:error',this,false);}},delegateEvents:function(events){events=events||_.result(this,'events')||(this.def?this.def.events:null);if(!events){return;}
events['click a[href="javascript:void(0)"]']='_handleBadLinkHref';events['click a[href="javascript:void(0);"]']='_handleBadLinkHref';_fieldProto.delegateEvents.call(this,events);},bindDomChange:function(){this.$(this.fieldTag).on('focus',_.bind(_.debounce(this.handleFocus,40),this));_fieldProto.bindDomChange.call(this);},handleFocus:function(){if(this.disposed){return;}
var $flexList=this.$el.closest('.flex-list-view-content');if(!_.isUndefined($flexList)){var previousScrollLeftValue=$flexList.data('previousScrollLeftValue');if(!_.isUndefined(previousScrollLeftValue)&&$flexList.scrollLeft()!==previousScrollLeftValue){$flexList.scrollLeft(previousScrollLeftValue);$flexList.removeData('previousScrollLeftValue');}}
var left=this.$el.position().left;var right=this.$el.outerWidth()+left;var top=this.$el.offset().top;var bottom=this.$el.outerHeight()+top;var fieldPadding=parseInt(this.$el.parent().css('padding-left'),10);this.view.trigger('field:focus:location',{left:left,right:right,top:top,bottom:bottom,fieldPadding:fieldPadding});},_handleBadLinkHref:function(evt){evt.preventDefault();}});});})(SUGAR.App);