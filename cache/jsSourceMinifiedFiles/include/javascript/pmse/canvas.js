var PMSE=PMSE||{};var AdamCanvas=function(options){jCore.Canvas.call(this,options);this.dia_id=null;this.projectUid="";this.project=null;this.currentMenu=null;this.modal=null;this.isClicked=false;AdamCanvas.prototype.initObject.call(this,options);};AdamCanvas.prototype=new jCore.Canvas();AdamCanvas.prototype.type="AdamCanvas";AdamCanvas.prototype.getProjectUid=function(){return this.projectUid;};AdamCanvas.prototype.getType=function(){return this.type;};AdamCanvas.prototype.setDiaUid=function(id){this.dia_id=id;return this;};AdamCanvas.prototype.setProjectUid=function(value){this.projectUid=value;return this;};AdamCanvas.prototype.setProject=function(value){this.project=value;return this;};AdamCanvas.prototype.setCurrentMenu=function(obj){if(this.currentMenu){this.currentMenu.hide();}
this.currentMenu=obj;return this;};AdamCanvas.prototype.initObject=function(options){var defaultOptions={projectUid:null};this.modal=new PMSE.Modal();$.extend(true,defaultOptions,options);this.setProjectUid(defaultOptions.projectUid).setDiaUid(defaultOptions.dia_id);};AdamCanvas.prototype.showModal=function(){this.modal.show();return this;};AdamCanvas.prototype.hideModal=function(){this.modal.hide();return this;};AdamCanvas.prototype.getContextMenu=function(){var f,w,hiddenTerminateField,hiddenNameModule,itemMatrix,fnTerminateFields,fieldsItems,processName,processDescription,comboModulesFields,comboModules,comboOperators,criteriaField,proxyModule,callbackModule,saveAction,refreshAction,zoom50Action,zoom75Action,zoom100Action,zoom125Action,zoom150Action,wAlert,fAlert,proOldModuleField,oldModule,proxyConfirm,proModuleField,alertLabel,message,result,mp2,modules,data,errorModulem,checkModuleAndSaveData,cancelInformation,proLockedFieldBKP,url;hiddenNameModule=new HiddenField({name:'pro_module'});processName=new TextField({name:'prj_name',label:translate('LBL_PMSE_LABEL_PROCESS_NAME'),required:true});processDescription=new TextareaField({name:'prj_description',label:translate('LBL_PMSE_LABEL_DESCRIPTION')});itemMatrix=new ItemMatrixField({jtype:'itemmatrix',label:translate('LBL_PMSE_LABEL_LOCKED_FIELDS'),name:'pro_locked_variables',submit:true,fieldWidth:350,fieldHeight:90,visualStyle:'table',nColumns:2});criteriaField=new CriteriaField({name:'pro_terminate_variables',label:translate('LBL_PMSE_LABEL_TERMINATE_PROCESS'),dateFormat:App.date.getUserDateFormat(),timeFormat:App.user.getPreference("timepref"),required:false,fieldWidth:414,fieldHeight:80,decimalSeparator:SUGAR.App.config.defaultDecimalSeparator,numberGroupingSeparator:SUGAR.App.config.defaultNumberGroupingSeparator,currencies:project.getMetadata("currencies"),operators:{logic:true,group:true},constant:false});fieldsItems=function(value,initial){App.alert.show('upload',{level:'process',title:'LBL_LOADING_NO_DOTS',autoclose:false});var val=new SugarProxy({url:'pmse_Project/CrmData/fields/'+value,uid:'',callback:null}),modulesFields;val.getData({call_type:'RR'},{success:function(modulesFields){hiddenNameModule.setValue(value);if(initial!==undefined){var lockedFields=AdamCanvas.prototype.expandLockedFields(PROJECT_LOCKED_VARIABLES,modulesFields.groupFieldsMap);itemMatrix.setList(modulesFields.result,lockedFields);}else{itemMatrix.setList(modulesFields.result);}
App.alert.dismiss('upload');w.html.style.display='inline';}});};comboModules=new ComboboxField({jtype:'combobox',label:translate('LBL_PMSE_FORM_LABEL_MODULE'),name:'comboModules',submit:false,readOnly:true,change:function(){return fieldsItems(this.value);},proxy:new SugarProxy({url:'pmse_Project/CrmData/modules',uid:'',callback:null})});proxyModule=new SugarProxy({url:'pmse_Project/CrmData/project/'+adamUID,uid:adamUID,callback:null});callbackModule={'loaded':function(data){App.alert.show('upload',{level:'process',title:'LBL_LOADING_NO_DOTS',autoclose:false});var arrOperator=[{'value':'equal','text':'='}],modules;var options=[];criteriaField.setModuleEvaluation({dataURL:"pmse_Project/CrmData/related/"+PROJECT_MODULE,dataRoot:"result",fieldDataURL:'pmse_Project/CrmData/fields/{{MODULE}}',fieldDataURLAttr:{call_type:'CN'},fieldDataRoot:"result"});processName.setValue(project.name);comboModules.proxy.getData(null,{success:function(modules){comboModules.setOptions(modules.result);comboModules.setValue(PROJECT_MODULE||modules.result[0].value);processName.setValue(project.name);processDescription.setValue(project.description);criteriaField.setValue(project.process_definition.pro_terminate_variables);PROJECT_LOCKED_VARIABLES=project.process_definition.pro_locked_variables.slice();fieldsItems(PROJECT_MODULE||modules.result[0].value,true);itemMatrix.setLockedFields(PROJECT_LOCKED_VARIABLES);oldModule=comboModules.value;}});},'submit':function(data){if(processName.value!==project.name){url=App.api.buildURL('pmse_Project',null,null,{filter:[{'name':processName.value}]});App.api.call("read",url,null,{success:function(a){if(a.records.length===0){checkModuleAndSaveData(data);}else{var mp=new MessagePanel({title:'Error',wtype:'Error',message:translate('LBL_PMSE_MESSAGE_THEPROCESSNAMEALREADYEXISTS','pmse_Project',processName.value)});mp.show();}}});}else{checkModuleAndSaveData(data);}}};checkModuleAndSaveData=function(oldData){if(comboModules.value!==oldModule){proLockedFieldBKP=oldData.pro_locked_variables;PROJECT_LOCKED_VARIABLES=itemMatrix.getLockedField();mp2.show();}else{data={description:processDescription.value,pro_terminate_variables:criteriaField.value,pro_locked_variables:oldData.pro_locked_variables};if(processName.value!==null&&processName.value!==''){data={name:processName.value,description:processDescription.value,pro_locked_variables:oldData.pro_locked_variables,pro_terminate_variables:criteriaField.value};project.setName(PROJECT_NAME=processName.value);}
project.process_definition.pro_terminate_variables=criteriaField.value;project.setDescription(PROJECT_DESCRIPTION=processDescription.value);proxyModule.sendData(data);PROJECT_LOCKED_VARIABLES=itemMatrix.getLockedField();project.process_definition.pro_locked_variables=itemMatrix.getLockedField();w.close();}};proxyConfirm=new SugarProxy({url:'pmse_Project/CrmData/putData/'+adamUID,uid:adamUID,callback:null});proModuleField=new HiddenField({name:'pro_new_module'});proOldModuleField=new HiddenField({name:'pro_old_module'});alertLabel=new LabelField({name:'lblAlert',label:translate('LBL_PMSE_FORM_LABEL_THE_WARNING'),options:{marginLeft:35}});mp2=new MessagePanel({title:"Module change warning",wtype:'Confirm',message:translate('LBL_PMSE_MESSAGE_REMOVE_ALL_START_CRITERIA'),buttons:[{jtype:'normal',caption:translate('LBL_PMSE_BUTTON_OK'),handler:function(){data={prj_name:processName.value,prj_description:processDescription.value,pro_locked_variables:proLockedFieldBKP,pro_module:comboModules.value};project.setDescription(PROJECT_DESCRIPTION=processDescription.value);project.setName(PROJECT_NAME=processName.value);proxyModule.sendData(data);PROJECT_MODULE=comboModules.value;project.canvas.cleanAllFlowConditions();data={pro_new_module:PROJECT_MODULE,pro_old_module:oldModule};proxyConfirm.sendData(data,{success:function(response){if(!response.success){errorModule=new MessagePanel({title:"Error",wtype:'Error',message:translate('LBL_PMSE_ADAM_ENGINE_ERROR_UPDATEBPMFLOW')});errorModule.show();}else{w.close();}},failure:function(xhr,response){}});mp2.hide();}},{jtype:'normal',caption:translate('LBL_PMSE_BUTTON_CANCEL'),handler:function(){comboModules.removeOptions();comboModules.proxy.getData(null,{success:function(modules){processName.setValue(project.name);processDescription.setValue(project.description);comboModules.setOptions(modules.result);comboModules.setValue(oldModule);criteriaField.setValue(project.process_definition.pro_terminate_variables);PROJECT_LOCKED_VARIABLES=project.process_definition.pro_locked_variables.slice();fieldsItems(PROJECT_MODULE||modules.result[0].value,true);itemMatrix.setLockedFields(PROJECT_LOCKED_VARIABLES);oldModule=PROJECT_MODULE;mp2.hide();}});}}]});f=new PMSE.Form({items:[processName,processDescription,comboModules,criteriaField,itemMatrix,hiddenNameModule],buttons:[{jtype:'normal',caption:translate('LBL_PMSE_BUTTON_SAVE'),handler:function(){f.submit();},cssClasses:['btn','btn-primary']},{jtype:'normal',caption:translate('LBL_PMSE_BUTTON_CANCEL'),handler:function(){if(f.isDirty()){cancelInformation=new MessagePanel({title:"Confirm",wtype:'Confirm',message:translate('LBL_PMSE_MESSAGE_CANCEL_CONFIRM'),buttons:[{jtype:'normal',caption:translate('LBL_PMSE_BUTTON_YES'),handler:function(){PROJECT_LOCKED_VARIABLES=project.process_definition.pro_locked_variables.slice();cancelInformation.close();w.close();}},{jtype:'normal',caption:translate('LBL_PMSE_BUTTON_NO'),handler:function(){cancelInformation.close();}}]});cancelInformation.show();}else{w.close();}},cssClasses:['btn btn-invisible btn-link']}],callback:callbackModule,proxy:null,language:PMSE_DESIGNER_FORM_TRANSLATIONS});w=new PMSE.Window({width:690,height:450,modal:true,title:translate('LBL_PMSE_CONTEXT_MENU_PROCESS_DEFINITION')});w.addPanel(f);saveAction=new PMSE.Action({text:translate('LBL_PMSE_CONTEXT_MENU_SAVE'),cssStyle:'adam-menu-icon-save',handler:function(){project.save();jCore.getActiveCanvas().RemoveCurrentMenu();},disabled:!project.isDirty});refreshAction=new PMSE.Action({text:translate('LBL_PMSE_CONTEXT_MENU_REFRESH'),cssStyle:'adam-menu-icon-refresh',handler:function(){document.location.reload(true);}});zoom50Action=new PMSE.Action({text:translate('LBL_PMSE_CONTEXT_MENU_50'),cssStyle:'',handler:function(){jCore.getActiveCanvas().applyZoom(1);$('#zoom').val(1);},selected:(jCore.getActiveCanvas().getZoomFactor()===0.5)});zoom75Action=new PMSE.Action({text:translate('LBL_PMSE_CONTEXT_MENU_75'),cssStyle:'',handler:function(){jCore.getActiveCanvas().applyZoom(2);$('#zoom').val(2);},selected:(jCore.getActiveCanvas().getZoomFactor()===0.75)});zoom100Action=new PMSE.Action({text:translate('LBL_PMSE_CONTEXT_MENU_100'),cssStyle:'',handler:function(){jCore.getActiveCanvas().applyZoom(3);$('#zoom').val(3);},selected:(jCore.getActiveCanvas().getZoomFactor()===1)});zoom125Action=new PMSE.Action({text:translate('LBL_PMSE_CONTEXT_MENU_125'),cssStyle:'',handler:function(){jCore.getActiveCanvas().applyZoom(4);$('#zoom').val(4);},selected:(jCore.getActiveCanvas().getZoomFactor()===1.25)});zoom150Action=new PMSE.Action({text:translate('LBL_PMSE_CONTEXT_MENU_150'),cssStyle:'',handler:function(){jCore.getActiveCanvas().applyZoom(5);$('#zoom').val(5);},selected:(jCore.getActiveCanvas().getZoomFactor()===1.5)});return{items:[new PMSE.Action({text:translate('LBL_PMSE_CONTEXT_MENU_PROCESS_DEFINITION'),cssStyle:'adam-menu-icon-configure',handler:function(){w.show();w.html.style.display='none';}}),{jtype:'separator'},saveAction,refreshAction,{label:translate('LBL_PMSE_CONTEXT_MENU_ZOOM'),icon:'adam-menu-icon-zoom',menu:{items:[zoom50Action,zoom75Action,zoom100Action,zoom125Action,zoom150Action]}}]};};AdamCanvas.prototype.onRightClickHandler=function(element,x,y){var contextMenu,factoryCMenu;factoryCMenu=element.getContextMenu();if(factoryCMenu.items){factoryCMenu.canvas=this;contextMenu=new PMSE.Menu(factoryCMenu);contextMenu.setParent(element);contextMenu.show(x,y);}else{this.RemoveCurrentMenu();}};AdamCanvas.prototype.dropBehaviorFactory=function(type,selectors){var out;if(type==='container'){if(!this.containerDropBehavior){this.containerDropBehavior=new AdamContainerDropBehavior(selectors);}
out=this.containerDropBehavior;}else{out=jCore.BehavioralElement.prototype.dropBehaviorFactory.call(this,type,selectors);}
return out;};AdamCanvas.prototype.onCreateElementHandler=function(element){this.RemoveCurrentMenu();if(this.project instanceof AdamProject){this.project.addElement(element);var items2=this.getDiagramTree();Tree.treeReload('tree',items2);}};AdamCanvas.prototype.onChangeElementHandler=function(element){if(this.project instanceof AdamProject){this.project.updateElement(element);var items2=this.getDiagramTree();Tree.treeReload('tree',items2);if(element.length===1){this.project.updatePropertiesGrid(element[0].type!=='Connection'?this.customShapes.find('id',element[0].id):this.connections.find('id',element[0].id));}}};AdamCanvas.prototype.onRemoveElementHandler=function(element){var i,items,sizeItems,item;if(this.project instanceof AdamProject){this.project.removeElement(element);var items2=this.getDiagramTree();Tree.treeReload('tree',items2);this.project.updatePropertiesGrid();}};AdamCanvas.prototype.triggerCommandAdam=function(receiver,propertyNames,oldValues,newValues){var fields=[],i;for(i=0;i<propertyNames.length;i+=1){fields.push({field:propertyNames[i],newVal:newValues[i],oldVal:oldValues[i]});}
this.updatedElement=[{fields:fields,id:receiver.id,relatedObject:receiver,type:receiver.type,adam:true}];$(this.html).trigger('changeelement');};AdamCanvas.prototype.triggerFlowConditionChangeEvent=function(element,oldValues){this.updatedElement=[{id:element.id,type:element.type,fields:[{field:"condition",oldVal:oldValues.condition,newVal:element.getFlowCondition()},{field:"type",oldVal:oldValues.type,newVal:element.getFlowType()}]}];$(this.html).trigger('changeelement');};AdamCanvas.prototype.triggerTextChangeEvent=function(element,oldText,newText){var valid,reg,e,nText,mp;reg=/<[^\s]/g;nText=newText.trim();e=reg.test(nText);if(e){nText=nText.replace(/</g,'< ');}
valid=this.validateName(element,nText);if(!valid.valid){element.parent.updateLabelsPosition(true,true);element.parent.setName(oldText);mp=new MessagePanel({title:'Error',wtype:'Error',message:valid.message});mp.show();return;}
this.updatedElement=[{id:element.parent.id,type:element.parent.type,relatedObject:element.parent,fields:[{field:"name",oldVal:oldText,newVal:nText}]}];element.parent.setName(nText);$(this.html).trigger("changeelement");};AdamCanvas.prototype.triggerDefaultFlowChangeEvent=function(elements){this.updatedElement=elements;$(this.html).trigger("changeelement");};AdamCanvas.prototype.triggerConnectionConditionChangeEvent=function(element,fields){this.updatedElement=[{id:element.id,type:element.type,relatedObject:element,fields:fields}];$(this.html).trigger("changeelement");};AdamCanvas.prototype.triggerPortChangeEvent=function(port){var direction=port.connection.srcPort.getID()===port.getID()?"src":"dest",map={src:{x:"x1",y:"y1",parent:"element_origin",type:'element_origin_type'},dest:{x:"x2",y:"y2",parent:"element_dest",type:'element_dest_type'}},point,state,zomeedState=[],i;port.connection.savePoints();state=port.connection.getPoints();for(i=0;i<state.length;i+=1){point=port.connection.points[i];zomeedState.push(new jCore.Point(point.x / this.zoomFactor,point.y / this.zoomFactor));}
point=direction==="src"?zomeedState[0]:zomeedState[state.length-1];this.updatedElement=[{id:port.connection.getID(),type:port.connection.type,fields:[{field:map[direction].x,oldVal:point.x,newVal:point.x},{field:map[direction].y,oldVal:point.y,newVal:point.y},{field:map[direction].parent,oldVal:(port.getOldParent())?port.getOldParent().getID():null,newVal:port.getParent().getID()},{field:map[direction].type,oldVal:port.connection.getNativeType(port.getParent()).type,newVal:port.connection.getNativeType(port.getParent()).type},{field:"state",oldVal:port.connection.getOldPoints(),newVal:zomeedState},{field:"condition",oldVal:"",newVal:port.connection.getFlowCondition()}],relatedObject:port}];$(this.html).trigger('changeelement');};AdamCanvas.prototype.RemoveCurrentMenu=function(){if(this.currentMenu){this.currentMenu.hide();}};AdamCanvas.prototype.onSelectElementHandler=function(element){this.hideAllFocusedLabels();this.project.onCanvasClick();this.RemoveCurrentMenu();};AdamCanvas.prototype.onRightClick=function(canvas){return function(event,e,element){if(e){var x=e.pageX-canvas.x+canvas.leftScroll,y=e.pageY-canvas.y+canvas.topScroll;canvas.updatedElement=element;canvas.hideAllFocusedLabels();if(element.family!=='Canvas'){canvas.emptyCurrentSelection();canvas.addToSelection(element);}
canvas.onRightClickHandler(canvas.updatedElement,x,y);}};};AdamCanvas.prototype.onClickHandler=function(canvas,x,y){this.RemoveCurrentMenu();this.project.onCanvasClick();};AdamCanvas.prototype.getTreeItem=function(shape){var cls='',name='',item={};switch(shape.getType()){case'AdamActivity':switch(shape.getActivityType()){case'TASK':cls='adam-tree-icon-user-task';name=(shape.getName()&&shape.getName()!=='')?shape.getName():'Task';break;default:cls='adam-tree-icon-user-task';name=(shape.getName()&&shape.getName()!=='')?shape.getName():'Task';break;}
break;case'AdamEvent':switch(shape.getEventType()){case'START':cls='adam-tree-icon-start';if(shape.getEventMessage()!==null&&shape.getEventMessage()!==''){if(shape.getEventMessage()==='Opportunities'){cls='adam-tree-icon-start-opportunities';}else if(shape.getEventMessage()==='Leads'){cls='adam-tree-icon-start-leads';}else if(shape.getEventMessage()==='Documents'){cls='adam-tree-icon-start-documents';}}
name=(shape.getName()&&shape.getName()!=='')?shape.getName():'Start';break;case'INTERMEDIATE':if(shape.getEventMarker()!==null&&shape.getEventMarker()!==''){if(shape.getEventMarker()==='TIMER'){cls='adam-tree-icon-intermediate-timer';}else{cls='adam-tree-icon-intermediate-message';}}
name=(shape.getName()&&shape.getName()!=='')?shape.getName():'Intermediate';break;case'BOUNDARY':cls='adam-tree-icon-intermediate-boundary';name=(shape.getName()&&shape.getName()!=='')?shape.getName():'Boundary';break;case'END':cls='adam-tree-icon-end';name=(shape.getName()&&shape.getName()!=='')?shape.getName():'End';break;}
break;case'AdamGateway':if(shape.getGatewayType()==='PARALLEL'){cls='adam-tree-icon-gateway-parallel';}else{cls='adam-tree-icon-gateway-exclusive';}
name=(shape.getName()&&shape.getName()!=='')?shape.getName():'Gateway';break;case'AdamData':if(shape.getDataType()==='DATAOBJECT'){cls='bpmn_icon_dataobject';name=(shape.getName()&&shape.getName()!=='')?shape.getName():'Data Object';}else{cls='bpmn_icon_datastore';name=(shape.getName()&&shape.getName()!=='')?shape.getName():'Data Store';}
break;case'AdamArtifact':if(shape.getArtifactType()==='TEXTANNOTATION'){cls='adam-tree-icon-textannotation';name=(shape.getName()&&shape.getName()!=='')?shape.getName():'Text Annotation';}else{cls='bpmn_icon_group';name=(shape.getName()&&shape.getName()!=='')?shape.getName():'Group';}
break;}
item={name:name,icon:cls,id:shape.getID()};return item;};AdamCanvas.prototype.buildRecursiveNode=function(root,canvas){var i,items=[],item,elem;canvas.children.sort(function(a,b){return a.x-b.x;});for(i=0;i<canvas.children.getSize();i+=1){elem=canvas.children.get(i);if(elem.type!=='MultipleSelectionContainer'){item=this.getTreeItem(elem);if(elem.children.getSize()>0){this.buildRecursiveNode(item,elem);}
items.push(item);}}
$.extend(root,{'items':items});};AdamCanvas.prototype.getDiagramTree=function(){var diaTree=[],tree={name:this.name};this.buildRecursiveNode(tree,this);diaTree.push(tree);return diaTree;};AdamCanvas.prototype.addConnection=function(conn){jCore.Canvas.prototype.addConnection.call(this,conn);if(conn.flo_state&&conn.inUndo!==true){conn.disconnect(true).connect({algorithm:'user',points:conn.flo_state});conn.setSegmentMoveHandlers();}};AdamCanvas.prototype.hideAllFocusedLabels=function(){var size=this.customShapes.getSize(),i,shape;for(i=0;i<size;i+=1){shape=this.customShapes.get(i);shape.labels.get(0).loseFocus();}
return true;};AdamCanvas.prototype.validateName=function(element,newText){var shape=element.parent,shape_aux,limit=this.getCustomShapes().getSize(),i,msg='',rt=true,nText=newText.trim(),str;if(nText===''){if(shape.type==='AdamActivity'){msg=translate('LBL_PMSE_MESSAGE_ACTIVITY_NAME_EMPTY');rt=false;}}else{for(i=0;i<limit;i+=1){shape_aux=this.getCustomShapes().get(i);if((shape_aux.getID()!==shape.getID())&&(shape_aux.type===shape.type)){if(shape_aux.getName().toUpperCase()===nText.toUpperCase()){str=translate('LBL_PMSE_MESSAGE_ACTIVITY_NAME_ALREADY_EXISTS');msg=str.replace('%s',nText);rt=false;break;}}}}
return{valid:rt,message:msg};};AdamCanvas.prototype.validatePositions=function(shape,coordinates){var result=true;if(coordinates.y<shape.getZoomHeight()/ 2){result=false;}
if(coordinates.y>(this.getHeight()-(shape.getZoomHeight()/ 2)-30)){result=false;}
if(coordinates.x<shape.getZoomWidth()/ 2){result=false;}
if(coordinates.x>(this.getWidth()-(shape.getZoomWidth()/ 2)-50)){result=false;}
return result;};AdamCanvas.prototype.cleanAllFlowConditions=function(){var cleaned=0,flow=this.connections.asArray(),i;for(i=0;i<flow.length;i+=1){if(flow[i].flo_condition!==''){flow[i].flo_condition='';cleaned+=1;}}
return cleaned;};AdamCanvas.prototype.expandLockedFields=function(lockedFields,groupFieldsMap){var retLockedFields=[];lockedFieldsLength=lockedFields.length;for(i=0;i<lockedFieldsLength;i++){if((groupFieldsMap[lockedFields[i]])&&(_.indexOf(retLockedFields,groupFieldsMap[lockedFields[i]])==-1)){retLockedFields.push(groupFieldsMap[lockedFields[i]]);};if($.inArray(lockedFields[i],retLockedFields)==-1){retLockedFields.push(lockedFields[i]);};};return retLockedFields;};