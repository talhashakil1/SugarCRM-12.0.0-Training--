(function($){var SearchAhead=function(element,options){this.options=$.extend({},$.fn.searchahead.defaults,options);this.$element=$(element);this.request=this.options.request;this.compiler=this.options.compiler;this.context=options.context||null;this.$button=this.options.buttonElement?$(this.options.buttonElement):null;this.throttle=this.options.throttle||this.throttle;this.throttleMillis=this.options.throttleMillis||this.throttleMillis;this.$menu=$(this.options.menu).appendTo(this.$element.parent().next('.typeahead-wrapper'));this.shown=false;this.minChars=this.options.minChars||1;this.patchIfZepto();this.listen();this.onEnterFn=this.options.onEnterFn||null;};SearchAhead.prototype={constructor:SearchAhead,compile:function(data){return(this.compiler({data:data,term:encodeURIComponent(this.query)}));},disabled:false,enable:function(){this.disabled=false;},disable:function(millis){var self=this;self.disabled=true;self.hide();setTimeout(function(){self.hide();},self.throttleMillis);setTimeout(function(){self.enable();},millis);},throttleMillis:250,throttle:function(callback,millis){var timerId=null;timerId=setTimeout(function(){callback();},millis);},go:function(){var activeItem=null,href=null,term=null;activeItem=this.$menu.find('.active');href=activeItem.find('a').attr('href');if(href){if(this.onEnterFn){if(this.context){this.onEnterFn.call(this.context,href,true);}else{this.onEnterFn(href,true);}}else{window.location=href;}}else{term=encodeURIComponent(this.$element.val());if(term&&term.length){if(this.onEnterFn){if(this.context){this.onEnterFn.call(this.context,term,false);}else{this.onEnterFn(term,false);}}}}
return this.hide();},show:function(){this.$menu.show();this.shown=true;if(!this.disabled){this.$menu.show();this.shown=true;return this;}
return null;},hide:function(){this.$menu.hide();this.shown=false;return this;},buttonLookup:function(evt){evt.stopPropagation();evt.preventDefault();this.lookup(evt);this.$element.focus();},lookup:function(evt){var that=this,items;this.query=this.$element.val();if(!this.query){return this.shown?this.hide():this;}
this.onSearch(evt);},onSearch:function(evt){var self=this;if($.inArray(evt.keyCode,[40,38,9,13,27])===-1){evt.preventDefault();self.throttle(function(){self.query=self.$element.val();if(self.query&&self.query.length>=self.minChars){if(self.context){self.request.call(self.context,self.query);}else{self.request(self.query);}}else{self.hide();}},self.throttleMillis);}},provide:function(data){var trimmed,markup=this.compile(data),self=this;trimmed=markup.replace(/^\s+/,'').replace(/\s+$/,'');if(trimmed.length){self.$menu.html(markup);if(!self.disabled){return self.show();}}
return null;},move:function(event,direction){var active=this.$menu.find('.active').removeClass('active'),move;if(direction==='next'){move=active.next();}else{move=active.prev();}
if(!move.length){move=$(this.$menu.find('li')[0]);}
move.addClass('active');},next:function(e){this.move(e,'next');},prev:function(e){this.move(e,'prev');},patchIfZepto:function(){if(!_.isUndefined(window.Zepto)){$.support={};$.proxy=function(fn,context){var args,tmp,proxy;if(typeof context==="string"){tmp=fn[context];context=fn;fn=tmp;}
if(!$.isFunction(fn)){return undefined;}
args=Array.prototype.slice.call(arguments,2);proxy=function(){return fn.apply(context,args.concat(Array.prototype.slice.call(arguments)));};proxy.guid=fn.guid=fn.guid||proxy.guid||$.guid++;return proxy;};}},listen:function(){this.$element.on('blur',$.proxy(this.blur,this)).on('keypress',$.proxy(this.keypress,this)).on('keyup',$.proxy(this.keyup,this));if(_.some([/chrome/,/safari/,/opera\//,/webkit/,/msie/],function(rx){return rx.test(navigator.userAgent.toLowerCase());})){this.$element.on('keydown',$.proxy(this.keypress,this));}
if(this.$button){this.$button.on('click',$.proxy(this.buttonLookup,this));if(app.accessibility){app.accessibility.run(this.$button,'click');}}
this.$menu.on('mouseenter','li',$.proxy(this.mouseenter,this));},keyup:function(e){switch(e.keyCode){case 40:case 38:break;case 9:if(!this.options.tabToSelect)
break;case 13:if(this.onEnterFn){this.go();break;}
if(!this.shown)return;this.lookup(e);break;case 27:if(!this.shown)return;this.hide();break;default:this.lookup(e);}
e.stopPropagation();e.preventDefault();},keypress:function(e){if(!this.shown)return;switch(e.keyCode){case 9:case 13:case 27:e.preventDefault();break;case 38:if(e.type!=='keydown')break;e.preventDefault();this.prev();break;case 40:if(e.type!=='keydown')break;e.preventDefault();this.next();break;}
e.stopPropagation();},blur:function(e){var that=this;setTimeout(function(){that.hide();},500);},mouseenter:function(e){this.$menu.find('.active').removeClass('active');$(e.currentTarget).addClass('active');}};$.fn.searchahead=function(){var option=arguments[0],args=Array.prototype.slice.call(arguments,1);return this.each(function(){var $this=$(this),data=$this.data('searchahead'),options=typeof option==='object'&&option;if(!data){$this.data('searchahead',(data=new SearchAhead(this,options)));}
if(typeof option==='string'){data[option].apply(data,args);}});};$.fn.searchahead.defaults={items:10,menu:'<ul class="typeahead dropdown-menu"></ul>'};$.fn.searchahead.Constructor=SearchAhead;})(window.$);
/* End of File portal2/lib/sugar.searchahead.js */

(function(app){app.error=_.extend(app.error);function backToLogin(bDismiss){if(bDismiss)app.alert.dismissAll();app.router.login();}
function alertUser(key,title,msg){app.alert.show(key,{level:'error',title:app.lang.get(title),messages:app.lang.get(msg)});}
app.events.on('app:sync:public:error',function(error){alertUser('public_sync_failure','Unable to load the application.');});app.error.handleNeedLoginError=function(error){backToLogin(true);alertUser('needs_login_error','LBL_PORTAL_INVALID_CREDS_TITLE','LBL_PORTAL_LOGIN_UNSUCCESSFUL');};app.error.handleInvalidGrantError=function(error){backToLogin(true);alertUser("invalid_grant_error","LBL_PORTAL_INVALID_GRANT_TITLE","LBL_PORTAL_INVALID_GRANT");};app.error.handleInvalidClientError=function(error){backToLogin(true);alertUser("invalid_client_error","LBL_PORTAL_AUTH_FAILED_TITLE","LBL_PORTAL_AUTH_FAILED");};app.error.handleInvalidRequestError=function(error){backToLogin(true);alertUser("invalid_request_error","LBL_PORTAL_INVALID_REQUEST_TITLE","LBL_PORTAL_INVALID_REQUEST");};app.error.handleUnspecified400Error=function(error){app.controller.loadView({layout:'error',errorType:'400',module:'Error',create:true});};app.error.handleTimeoutError=function(error){backToLogin(true);alertUser("timeout_error","LBL_PORTAL_REQUEST_TIMEOUT_TITLE","LBL_PORTAL_REQUEST_TIMEOUT");};app.error.handleUnauthorizedError=function(error){backToLogin(true);alertUser("unauthorized_request_error","LBL_PORTAL_UNAUTHORIZED_TITLE","LBL_PORTAL_UNAUTHORIZED");};app.error.handleForbiddenError=function(error){app.alert.dismissAll();if(error.code=="portal_not_configured"){backToLogin(true);}
alertUser("forbidden_request_error","LBL_PORTAL_RESOURCE_UNAVAILABLE_TITLE",error.message?error.message:"LBL_PORTAL_RESOURCE_UNAVAILABLE");};app.error.handleNotFoundError=function(error){app.controller.loadView({layout:"error",errorType:"404",module:"Error",create:true});};app.error.handleMethodNotAllowedError=function(error){backToLogin(true);alertUser("not_allowed_error","LBL_PORTAL_METHOD_NOT_ALLOWED_TITLE","LBL_PORTAL_METHOD_NOT_ALLOWED");};app.error.handleHeaderPreconditionFailed=function(error){app.sync();};app.error.handleMethodFailureError=function(error){backToLogin(true);alertUser("precondtion_failure_error","LBL_PORTAL_PRECONDITION_MISSING_TITLE","LBL_PORTAL_PRECONDITION_MISSING");};app.error.handleServerError=function(error){app.controller.loadView({layout:"error",errorType:error.status||"500",module:"Error",error:error,create:true});};})(SUGAR.App);
/* End of File portal2/error.js */

(function(app){app.user=_.extend(app.user);app.user.isSupportPortalUser=function(){return this.get('type')==='support_portal';};})(SUGAR.App);
/* End of File portal2/user.js */

(function(app){app.events.on('router:init',function(){var routes=[{name:'portal-index',route:'',callback:loadHome,},{name:'logout',route:'logout/?clear=:clear'},{name:'logout',route:'logout'},{name:'forgotpassword',route:'forgotpassword',callback:function(){app.controller.loadView({layout:'forgotpassword',create:true});}},{name:'resetpwdconfirmation',route:'resetpwdconfirmation',callback:function(){app.controller.loadView({layout:'resetpwdconfirmation',create:true});}},{name:'signup',route:'signup',callback:function(){if(app.config.enableSelfSignUp!=='enabled'){app.router.redirect('/');return;}
app.controller.loadView({module:'Signup',layout:'signup',create:true});}},{name:'signup-success',route:'signup-success',callback:function(){app.controller.loadView({layout:'signup-success',create:true});}},{name:'resetpassword',route:'resetpassword/:id',callback:function(id){app.controller.loadView({layout:'resetpassword',resetID:id,create:true});}},{name:'contact-info',route:'contact-info',callback:function(){app.controller.loadView({layout:'contact-info',create:true});}},{name:'search',route:'search/:query',callback:function(query){try{var decodedQuery=decodeURIComponent(query);app.controller.loadView({mixed:true,module:'Search',layout:'search',query:decodedQuery,skipFetch:true});}catch(err){app.logger.error('Search term not a valid URI component.  Will not route search/'+query);}}},{name:'create',route:':module/create',callback:function(module){app.controller.loadView({module:module,layout:'records'});app.drawer.open({layout:'create',context:{create:true}},_.bind(function(context,model){var module=context.get('module')||model.module,route=app.router.buildRoute(module);app.router.navigate(route,{trigger:true});},this));}},{name:'profile',route:'profile',callback:function(){app.controller.loadView({layout:'record',module:'Contacts',modelId:app.user.get('id')});}},{name:'home',route:'Home',callback:loadHome,},{name:'list',route:':module'},{name:'record',route:':module/:id'}];app.router.addRoutes(routes);});var oHandleRenderError=app.error.handleRenderError;app.error.handleRenderError=function(component,method,additionalInfo){function handlePortalRenderDenied(c){var title=app.lang.get('ERR_NO_VIEW_ACCESS_TITLE');var module=app.lang.getModuleName(c.module,{plural:true});var message=app.utils.formatString(app.lang.get('ERR_NO_VIEW_ACCESS_MSG'),[module]);app.logger.warn(title+':\n'+message);}
if(method==='view_render_denied'){handlePortalRenderDenied(component);}else{oHandleRenderError(component,method,additionalInfo);}};var loadHome=function(){if(_.includes(app.metadata.getModuleNames({access:'read'}),'Dashboards')){app.controller.loadView({module:'Dashboards',layout:'servehome',});}else{app.controller.loadView({layout:'home',});}};var oRoutingBefore=app.routing.beforeRoute;app.routing.beforeRoute=function(route,args){var dm;var nonModuleRoutes=['search','error','profile','profileedit','logout','resetpassword'];app.logger.debug('Loading route. '+(route?route:'No route or undefined!'));if(!oRoutingBefore.call(this,route,args)){return false;}
if(app.api.isAuthenticated()&&!app.user.get('cookie_consent')){var reloadCb={complete:function(){window.location.reload();}};app.controller.loadView({layout:'consent-wizard',modelId:app.user.get('id'),module:'Contacts',callbacks:reloadCb,});app.additionalComponents.header.hide();return false;}
function alertUser(msg){msg=msg||'LBL_PORTAL_MIN_MODULES';app.alert.show('no-sidecar-access',{level:'error',title:app.lang.get('LBL_PORTAL_ERROR'),messages:[app.lang.get(msg)]});}
if(route==='index'){dm=typeof(app.config)!==undefined&&app.config.defaultModule?app.config.defaultModule:null;if(dm&&app.metadata.getModule(dm)&&app.acl.hasAccess('read',dm)){app.router.list(dm);}else if(app.acl.hasAccess('read','Home')){app.router.index();}else{alertUser();return false;}}else if(!_.include(nonModuleRoutes,route)&&args[0]&&!app.metadata.getModule(args[0])||!app.acl.hasAccess('read',args[0])){app.logger.error('Module not loaded or user does not have access. ',route);alertUser('LBL_PORTAL_ROUTE_ERROR');return false;}
return true;};app.Controller=app.Controller.extend({loadView:function(params){var self=this,callbackAppNotAvailable,options;if(params.layout==='login'){app.Controller.__super__.loadView.call(this,params);}
if(app.config&&app.config.appStatus=='offline'){if(params.layout!=='login'){options={module:'Login',layout:'login',create:true};app.Controller.__super__.loadView.call(self,options);}
callbackAppNotAvailable=function(data){app.alert.show('appOffline',{level:'error',title:app.lang.get('LBL_PORTAL_ERROR'),messages:app.lang.get('LBL_PORTAL_OFFLINE'),autoclose:false});};if(app.api.isAuthenticated()){app.logout({success:callbackAppNotAvailable,error:callbackAppNotAvailable},{clear:true});}else{callbackAppNotAvailable();}
return;}
if(params.layout!=='login'){app.Controller.__super__.loadView.call(this,params);}}});var __superBeanSave__=app.Bean.prototype.save;app.Bean.prototype.save=function(attributes,options){var defaultParams={portal_flag:1,portal_viewable:1};var moduleFields=app.metadata.getModule(this.module).fields||{};for(var field in defaultParams){if(moduleFields[field]){this.set(field,defaultParams[field],{silent:true});}}
__superBeanSave__.call(this,attributes,options);};app.events.on('app:sync:complete',function(){app.date.locale(app.user.getPreference('language'));});})(SUGAR.App);
/* End of File portal2/portal.js */

